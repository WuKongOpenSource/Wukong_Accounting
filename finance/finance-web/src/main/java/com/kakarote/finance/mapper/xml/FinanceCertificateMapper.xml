<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kakarote.finance.mapper.FinanceCertificateMapper">
    <select id="pageCallRecordList" resultType="com.kakarote.finance.entity.VO.FinanceCertificateVO">
        select a.certificate_id,DATE_FORMAT(a.certificate_time,'%Y-%m-%d') as certificate_time
        ,a.file_num,
        a.voucher_id,a.batch_id,a.debtor_balance,a.credit_balance,
        a.total,a.create_user_id,a.create_time,a.check_status,
        b.voucher_name,a.certificate_num as voucher_num,
        a.examine_user_id,CONCAT(b.voucher_name,'_',a.certificate_num) as certificate_num,
        w.statement_type
        from wk_finance_certificate as a
        left join wk_finance_voucher as b on a.voucher_id = b.voucher_id
        left join wk_finance_statement_certificate as v on v.certificate_id = a.certificate_id
        left join wk_finance_statement as w on v.statement_id = w.statement_id
        where DATE_FORMAT(a.certificate_time,'%Y%m') >= #{data.startTime}
        and DATE_FORMAT(a.certificate_time,'%Y%m') &lt;= #{data.endTime}
        and a.account_id = #{data.accountId}
        <if test="data.userId != null and data.userId != ''">
            and a.create_user_id = #{data.userId}
        </if>
        <if test="data.voucherId != null and data.voucherId != ''">
            and a.voucher_id = #{data.voucherId}
        </if>
        <if test="data.certificateNum != null and data.certificateNum != ''">
            and a.certificate_num = #{data.certificateNum}
        </if>
        <if test="data.checkStatus != null and data.checkStatus != ''">
            and a.check_status = #{data.checkStatus}
        </if>
        <if test="data.checkStatus == 0">
            and a.check_status = 0
        </if>
        and a.certificate_id in
        <foreach collection="data.certificateIds" index="index" open="(" close=")" separator="," item="certificateId">
            #{certificateId}
        </foreach>
        order by DATE_FORMAT(a.certificate_time,'%Y%m'), a.certificate_num
    </select>
    <select id="querySubjectIdsByTime" resultType="java.lang.Long">
        select DISTINCT t.subject_id
        from wk_finance_subject as t
        left join (
        select a.subject_id,
        ifnull(a.debtor_balance, 0) as debtor_balance,
        IFNULL(a.credit_balance, 0) as credit_balance
        from wk_finance_certificate_detail as a
        left join wk_finance_certificate as b on a.certificate_id = b.certificate_id
        where a.account_id = #{data.accountId}
        and a.subject_id is not null
        and b.certificate_id is not null
        GROUP BY a.subject_id
        ) as w on t.subject_id = w.subject_id
        left join wk_finance_initial as y on y.subject_id = t.subject_id
        where if(t.balance_direction = 1, ifnull(y.initial_balance, 0), 0 - ifnull(y.initial_balance, 0)) +
        IFNULL(w.debtor_balance, 0) - IFNULL(w.credit_balance, 0)
        != if(t.balance_direction = 2, ifnull(y.initial_balance, 0), 0 - ifnull(y.initial_balance, 0)) -
        IFNULL(w.debtor_balance, 0) + IFNULL(w.credit_balance, 0)
        and t.account_id = #{data.accountId}
        and (select DATE_FORMAT(start_time, '%Y%m') from wk_finance_parameter where account_id = #{data.accountId})
        &lt;= #{data.startTime}
        union all
        select DISTINCT a.subject_id
        from wk_finance_certificate_detail as a
        left join wk_finance_certificate as b on a.certificate_id = b.certificate_id
        where a.account_id = #{data.accountId}
        and a.subject_id is not null
        and DATE_FORMAT(b.certificate_time, '%Y%m') >= #{data.startTime}
        and DATE_FORMAT(b.certificate_time, '%Y%m') &lt;= #{data.endTime}
    </select>

    <select id="queryBalanceBySubjectIds" resultType="com.alibaba.fastjson.JSONObject">
        select ifnull(sum(a.debtor_balance),0) as debtor_balances,ifnull(sum(a.credit_balance),0) as credit_balances
        from wk_finance_certificate_detail as a
        left join wk_finance_certificate as b on a.certificate_id = b.certificate_id
        where a.subject_id in
        <foreach collection="ids" index="index" open="(" close=")" separator="," item="subjectId">
            #{subjectId}
        </foreach>
        and a.subject_id in
        <foreach collection="subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
            #{subjectId}
        </foreach>
        and DATE_FORMAT(b.certificate_time,'%Y%m') >= #{data.startTime}
        and DATE_FORMAT(b.certificate_time,'%Y%m') &lt;= #{data.endTime}
        and a.account_id = #{accountId}
    </select>
    <select id="queryDetailAccountBySubjectIds" resultType="com.alibaba.fastjson.JSONObject">
        select distinct last_day(DATE_FORMAT(#{data.startTime},'%Y-%m-%d')) as account_time,
        null as certificate_num , '期初余额' as digest_content , 0 as debtor_balance,
        0 as credit_balance,
        <if test="data.accountBookDirection == 2">
            case
            when
            ( (select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(z.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial as w
            left join wk_finance_subject as z on z.subject_id = w.subject_id
            where w.subject_id = #{data.subjectId}
            and w.account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0)) > 0 then '借'
            when ( (select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(z.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial as w
            left join wk_finance_subject as z on z.subject_id = w.subject_id
            where w.subject_id = #{data.subjectId}
            and w.account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0)) &lt; 0 then '贷'
            else '平'
            end as balance_direction,
            abs(( (select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(z.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial as w
            left join wk_finance_subject as z on z.subject_id = w.subject_id
            where w.subject_id = #{data.subjectId}
            and w.account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0))) as balance
        </if>
        <if test="data.accountBookDirection == 1">
            if((select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(z.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial as w
            left join wk_finance_subject as z on z.subject_id = w.subject_id
            where w.subject_id = #{data.subjectId}
            and w.account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0) = 0,'平',if((select balance_direction from wk_finance_subject where subject_id = #{data.subjectId}) =
            1,'借','贷') )
            as balance_direction,
            if((select balance_direction from wk_finance_subject where subject_id = #{data.subjectId}) = 1,
            (select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(z.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial as w
            left join wk_finance_subject as z on z.subject_id = w.subject_id
            where w.subject_id = #{data.subjectId}
            and w.account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0), (select ifnull(sum(e.credit_balance),0) - ifnull(sum(e.debtor_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(z.balance_direction = 2,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial as w
            left join wk_finance_subject as z on z.subject_id = w.subject_id
            where w.subject_id = #{data.subjectId}
            and w.account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0)) as balance
        </if>
        , '1' as `type`,null as certificate_id,DATE_FORMAT(#{data.startTime},'%Y%m') as monthTime
        ,DATE_FORMAT(#{data.startTime},'%Y') as yearTime
        union all
        <foreach collection="data.timeList" item="x" separator="union all">
            select * from(
            select DATE_FORMAT(a.certificate_time,'%Y-%m-%d') as account_time,
            CONCAT(c.voucher_name,'_',a.certificate_num) as certificate_num ,b.digest_content,
            ifnull(b.debtor_balance,0) as debtor_balance,
            ifnull(b.credit_balance,0) as credit_balance ,
            <if test="data.accountBookDirection == 1">
                if(d.balance_direction = 1,'借','贷') as balance_direction,
                if(d.balance_direction = 1,ifnull((select ifnull(sum(e.debtor_balance),0) -
                ifnull(sum(e.credit_balance),0)
                from wk_finance_certificate_detail as e
                left join wk_finance_certificate as w on e.certificate_id = w.certificate_id
                where DATE_FORMAT(w.certificate_time,'%Y%m') &lt;= #{x}
                and e.account_id = #{data.accountId}
                and e.subject_id = b.subject_id
                ),0), ifnull((select ifnull(sum(e.credit_balance),0) - ifnull(sum(e.debtor_balance),0)
                from wk_finance_certificate_detail as e
                left join wk_finance_certificate as w on e.certificate_id = w.certificate_id
                where DATE_FORMAT(w.certificate_time,'%Y%m') &lt;= #{x}
                and e.account_id = #{data.accountId}
                and e.subject_id = b.subject_id
                ),0)) as balance
            </if>
            <if test="data.accountBookDirection == 2">
                case
                when (ifnull(b.debtor_balance,0) - ifnull(b.credit_balance,0)+
                ifnull((select sum(initial_balance) from wk_finance_initial
                where subject_id = b.subject_id
                and account_id = #{data.accountId}
                and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                #{data.accountId})
                ),0)) > 0 then '借'
                when (ifnull(b.debtor_balance,0) - ifnull(b.credit_balance,0)+
                ifnull((select sum(initial_balance) from wk_finance_initial
                where subject_id = b.subject_id
                and account_id = #{data.accountId}
                and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                #{data.accountId})
                ),0)) = 0 then '平'
                else '贷'
                end as balance_direction,
                abs(ifnull(b.debtor_balance,0) - ifnull(b.credit_balance,0)) as balance
            </if>
            , '2' as `type`,a.certificate_id,DATE_FORMAT(a.certificate_time,'%Y%m') as monthTime
            ,DATE_FORMAT(a.certificate_time,'%Y') as yearTime
            from wk_finance_certificate_detail as b
            left join wk_finance_certificate as a on a.certificate_id = b.certificate_id
            left join wk_finance_voucher as c on a.voucher_id = c.voucher_id
            left join wk_finance_subject as d on b.subject_id = d.subject_id
            where DATE_FORMAT(a.certificate_time,'%Y%m') = #{x}
            and a.account_id = #{data.accountId}
            and b.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            order by a.certificate_time,a.certificate_num
            ) as lict
            union all
            select last_day(DATE_FORMAT(CONCAT(#{x},'01'),'%Y-%m-%d')) as account_time,
            null as certificate_num , '本期合计' as digest_content ,
            (select ifnull(sum(b.debtor_balance),0)
            from wk_finance_certificate_detail as b
            left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
            where DATE_FORMAT(a.certificate_time,'%Y%m') = #{x}
            and a.account_id = #{data.accountId}
            and b.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) as debtor_balance,
            (select ifnull(sum(b.credit_balance),0)
            from wk_finance_certificate_detail as b
            left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
            where DATE_FORMAT(a.certificate_time,'%Y%m') = #{x}
            and a.account_id = #{data.accountId}
            and b.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) as credit_balance,
            <if test="data.accountBookDirection == 1">
                if( (select ifnull(sum(b.debtor_balance),0) - ifnull(sum(b.credit_balance),0)
                from wk_finance_certificate_detail as b
                left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
                where DATE_FORMAT(a.certificate_time,'%Y%m') = #{x}
                and a.account_id = #{data.accountId}
                and b.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                ) +
                if((select DATE_FORMAT(start_time,'%Y%m') from wk_finance_parameter
                where account_id = #{data.accountId}
                ) = DATE_FORMAT(#{x},'%Y%m'),ifnull((select sum(initial_balance) from wk_finance_initial
                where subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                and account_id = #{data.accountId}
                and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                #{data.accountId})
                ),0),0 ) = 0,'平','借') as balance_direction,
                (select ifnull(sum(b.debtor_balance),0) - ifnull(sum(b.credit_balance),0)
                from wk_finance_certificate_detail as b
                left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
                where DATE_FORMAT(a.certificate_time,'%Y%m') = #{x}
                and a.account_id = #{data.accountId}
                and b.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                ) +
                if((select DATE_FORMAT(start_time,'%Y%m') from wk_finance_parameter
                where account_id = #{data.accountId}
                ) = DATE_FORMAT(#{x},'%Y%m'),ifnull((select sum(initial_balance) from wk_finance_initial
                where subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                and account_id = #{data.accountId}
                and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                #{data.accountId})
                ),0),0 ) as balance
            </if>
            <if test="data.accountBookDirection == 2">
                case
                when (select ifnull(sum(b.debtor_balance),0) - ifnull(sum(b.credit_balance),0)
                from wk_finance_certificate_detail as b
                left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
                where DATE_FORMAT(a.certificate_time,'%Y%m') = #{x}
                and a.account_id = #{data.accountId}
                and b.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                )+
                if((select DATE_FORMAT(start_time,'%Y%m') from wk_finance_parameter
                where account_id = #{data.accountId}
                ) = DATE_FORMAT(#{x},'%Y%m'),ifnull((select sum(initial_balance) from wk_finance_initial
                where subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                and account_id = #{data.accountId}
                and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                #{data.accountId})
                ),0),0 ) > 0 then '借'
                when (select ifnull(sum(b.debtor_balance),0) - ifnull(sum(b.credit_balance),0)
                from wk_finance_certificate_detail as b
                left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
                where DATE_FORMAT(a.certificate_time,'%Y%m') = #{x}
                and a.account_id = #{data.accountId}
                and b.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                ) +
                if((select DATE_FORMAT(start_time,'%Y%m') from wk_finance_parameter
                where account_id = #{data.accountId}
                ) = DATE_FORMAT(#{x},'%Y%m'),ifnull((select sum(initial_balance) from wk_finance_initial
                where subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                and account_id = #{data.accountId}
                and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                #{data.accountId})
                ),0),0 ) = 0 then '平'
                else '贷'
                end as balance_direction,
                abs((select ifnull(sum(b.debtor_balance),0) - ifnull(sum(b.credit_balance),0)
                from wk_finance_certificate_detail as b
                left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
                where DATE_FORMAT(a.certificate_time,'%Y%m') = #{x}
                and a.account_id = #{data.accountId}
                and b.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                ) +
                if((select DATE_FORMAT(start_time,'%Y%m') from wk_finance_parameter
                where account_id = #{data.accountId}
                ) = DATE_FORMAT(#{x},'%Y%m'),ifnull((select sum(initial_balance) from wk_finance_initial
                where subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                and account_id = #{data.accountId}
                and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                #{data.accountId})
                ),0),0 )) as balance
            </if>
            , '3' as `type`,'' as certificate_id,DATE_FORMAT(CONCAT(#{x},'01'),'%Y%m') as monthTime
            ,DATE_FORMAT(CONCAT(#{x},'01'),'%Y') as yearTime
            union all
            select last_day(DATE_FORMAT(CONCAT(#{x},'01'),'%Y-%m-%d')) as account_time,
            null as certificate_num , '本年累计' as digest_content ,
            (select ifnull(sum(b.debtor_balance),0)
            from wk_finance_certificate_detail as b
            left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
            where DATE_FORMAT(a.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01'),'%Y')
            and DATE_FORMAT(a.certificate_time,'%Y%m') &lt;= #{x}
            and a.account_id = #{data.accountId}
            and b.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) + if((select DATE_FORMAT(start_time,'%Y') from wk_finance_parameter
            where account_id = #{data.accountId}
            ) = DATE_FORMAT(CONCAT(#{x},'01'),'%Y'),ifnull((select sum(add_up_debtor_balance) from wk_finance_initial
            where subject_id = #{data.subjectId}
            and account_id = #{data.accountId}
            ),0),0 ) as debtor_balance,
            (select ifnull(sum(b.credit_balance),0)
            from wk_finance_certificate_detail as b
            left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
            where DATE_FORMAT(a.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01'),'%Y')
            and DATE_FORMAT(a.certificate_time,'%Y%m') &lt;= #{x}
            and a.account_id = #{data.accountId}
            and b.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) + if((select DATE_FORMAT(start_time,'%Y') from wk_finance_parameter
            where account_id = #{data.accountId}
            ) = DATE_FORMAT(CONCAT(#{x},'01'),'%Y'),ifnull((select sum(add_up_credit_balance) from wk_finance_initial
            where subject_id = #{data.subjectId}
            and account_id = #{data.accountId}
            ),0),0 ) as credit_balance,
            <if test="data.accountBookDirection == 1">
                if( (select ifnull(sum(b.debtor_balance),0) - ifnull(sum(b.credit_balance),0)
                from wk_finance_certificate_detail as b
                left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
                where DATE_FORMAT(a.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01'),'%Y')
                and DATE_FORMAT(a.certificate_time,'%Y%m') &lt;= #{x}
                and a.account_id = #{data.accountId}
                and b.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                ) = 0,'平','借' ) as balance_direction,
                (select ifnull(sum(b.debtor_balance),0) - ifnull(sum(b.credit_balance),0)
                from wk_finance_certificate_detail as b
                left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
                where DATE_FORMAT(a.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01'),'%Y')
                and DATE_FORMAT(a.certificate_time,'%Y%m') &lt;= #{x}
                and a.account_id = #{data.accountId}
                and b.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                ) as balance
            </if>
            <if test="data.accountBookDirection == 2">
                case
                when (select ifnull(sum(b.debtor_balance),0) - ifnull(sum(b.credit_balance),0)
                from wk_finance_certificate_detail as b
                left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
                where DATE_FORMAT(a.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01'),'%Y')
                and DATE_FORMAT(a.certificate_time,'%Y%m') &lt;= #{x}
                and a.account_id = #{data.accountId}
                and b.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                ) > 0 then '借'
                when (select ifnull(sum(b.debtor_balance),0) - ifnull(sum(b.credit_balance),0)
                from wk_finance_certificate_detail as b
                left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
                where DATE_FORMAT(a.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01'),'%Y')
                and DATE_FORMAT(a.certificate_time,'%Y%m') &lt;= #{x}
                and a.account_id = #{data.accountId}
                and b.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                ) = 0 then '平'
                else '贷'
                end as balance_direction,
                abs((select ifnull(sum(b.debtor_balance),0) - ifnull(sum(b.credit_balance),0)
                from wk_finance_certificate_detail as b
                left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
                where DATE_FORMAT(a.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01'),'%Y')
                and DATE_FORMAT(a.certificate_time,'%Y%m') &lt;= #{x}
                and a.account_id = #{data.accountId}
                and b.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                )) as balance
            </if>
            , '4' as `type`,null as certificate_id,DATE_FORMAT(CONCAT(#{x},'01'),'%Y%m') as monthTime
            ,DATE_FORMAT(CONCAT(#{x},'01'),'%Y') as yearTime
        </foreach>
    </select>
    <select id="queryDetailUpAccount" resultType="com.alibaba.fastjson.JSONObject">
        select distinct last_day(DATE_FORMAT(#{data.startTime},'%Y%m')) as account_time,
        null as certificate_num , '期初余额' as digest_content , null as debtor_balance,
        null as credit_balance,
        <if test="data.accountBookDirection == 1">
            if((select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(z.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial as w
            left join wk_finance_subject as z on z.subject_id = w.subject_id
            where w.subject_id = #{data.subjectId}
            and w.account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0) = 0,'平',if((select balance_direction from wk_finance_subject where subject_id = #{data.subjectId}) =
            1,'借','贷') )
            as balance_direction,
            if((select balance_direction from wk_finance_subject where subject_id = #{data.subjectId}) = 1,
            (select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(z.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial as w
            left join wk_finance_subject as z on z.subject_id = w.subject_id
            where w.subject_id = #{data.subjectId}
            and w.account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0), (select ifnull(sum(e.credit_balance),0) - ifnull(sum(e.debtor_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(z.balance_direction = 2,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial as w
            left join wk_finance_subject as z on z.subject_id = w.subject_id
            where w.subject_id = #{data.subjectId}
            and w.account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0)) as balance
        </if>
        <if test="data.accountBookDirection == 2">
            case
            when (select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(z.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial as w
            left join wk_finance_subject as z on z.subject_id = w.subject_id
            where w.subject_id = #{data.subjectId}
            and w.account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0) &lt; 0 then '贷'
            when (select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(z.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial as w
            left join wk_finance_subject as z on z.subject_id = w.subject_id
            where w.subject_id = #{data.subjectId}
            and w.account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0) > 0 then '借'
            ELSE '平'
            end as balance_direction ,
            abs((select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            )+
            ifnull((select if(z.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial as w
            left join wk_finance_subject as z on z.subject_id = w.subject_id
            where w.subject_id = #{data.subjectId}
            and w.account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0) ) as balance
        </if>
        , '1' as `type`,DATE_FORMAT(#{data.startTime},'%Y%m') as monthTime
        ,DATE_FORMAT(#{data.startTime},'%Y') as yearTime
        union all
        <foreach collection="data.timeList" item="x" separator="union all">
            select #{x} as account_time,
            null as certificate_num , '本期合计' as digest_content ,
            (select ifnull(sum(e.debtor_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') = #{x}
            and e.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) as debtor_balance,
            (select ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') = #{x}
            and e.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) as credit_balance,
            <if test="data.accountBookDirection == 1">
                <if test="data.balanceDirection == 1">
                    if((select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
                    from wk_finance_certificate_detail as e
                    left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
                    where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= #{x}
                    and c.account_id = #{data.accountId}
                    and e.subject_id in
                    <foreach collection="data.subjectIds" index="index" open="(" close=")" separator=","
                             item="subjectId">
                        #{subjectId}
                    </foreach>
                    ) +
                    ifnull((select if(z.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
                    from wk_finance_initial as w
                    left join wk_finance_subject as z on z.subject_id = w.subject_id
                    where w.subject_id = #{data.subjectId}
                    and w.account_id = #{data.accountId}
                    and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                    #{data.accountId})
                    ),0) = 0,'平','借') as balance_direction,
                    (select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
                    from wk_finance_certificate_detail as e
                    left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
                    where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= #{x}
                    and c.account_id = #{data.accountId}
                    and e.subject_id in
                    <foreach collection="data.subjectIds" index="index" open="(" close=")" separator=","
                             item="subjectId">
                        #{subjectId}
                    </foreach>
                    ) +
                    ifnull((select if(z.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
                    from wk_finance_initial as w
                    left join wk_finance_subject as z on z.subject_id = w.subject_id
                    where w.subject_id = #{data.subjectId}
                    and w.account_id = #{data.accountId}
                    and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                    #{data.accountId})
                    ),0) as balance
                </if>
                <if test="data.balanceDirection == 2">
                    if((select ifnull(sum(e.credit_balance),0) - ifnull(sum(e.debtor_balance),0)
                    from wk_finance_certificate_detail as e
                    left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
                    where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= #{x}
                    and c.account_id = #{data.accountId}
                    and e.subject_id in
                    <foreach collection="data.subjectIds" index="index" open="(" close=")" separator=","
                             item="subjectId">
                        #{subjectId}
                    </foreach>
                    ) +
                    ifnull((select if(z.balance_direction = 2,sum(initial_balance),0 - sum(initial_balance))
                    from wk_finance_initial as w
                    left join wk_finance_subject as z on z.subject_id = w.subject_id
                    where w.subject_id = #{data.subjectId}
                    and w.account_id = #{data.accountId}
                    and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                    #{data.accountId})
                    ),0) = 0,'平','贷') as balance_direction,
                    (select ifnull(sum(e.credit_balance),0) - ifnull(sum(e.debtor_balance),0)
                    from wk_finance_certificate_detail as e
                    left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
                    where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= #{x}
                    and c.account_id = #{data.accountId}
                    and e.subject_id in
                    <foreach collection="data.subjectIds" index="index" open="(" close=")" separator=","
                             item="subjectId">
                        #{subjectId}
                    </foreach>
                    ) +
                    ifnull((select if(z.balance_direction = 2,sum(initial_balance),0 - sum(initial_balance))
                    from wk_finance_initial as w
                    left join wk_finance_subject as z on z.subject_id = w.subject_id
                    where w.subject_id = #{data.subjectId}
                    and w.account_id = #{data.accountId}
                    and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                    #{data.accountId})
                    ),0) as balance
                </if>
            </if>
            <if test="data.accountBookDirection == 2">
                case
                when (select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
                from wk_finance_certificate_detail as e
                left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
                where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= #{x}
                and c.account_id = #{data.accountId}
                and e.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                ) +
                ifnull((select if(z.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
                from wk_finance_initial as w
                left join wk_finance_subject as z on z.subject_id = w.subject_id
                where w.subject_id = #{data.subjectId}
                and w.account_id = #{data.accountId}
                and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                #{data.accountId})
                ),0) &lt; 0 then '贷'
                when (select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
                from wk_finance_certificate_detail as e
                left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
                where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= #{x}
                and c.account_id = #{data.accountId}
                and e.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                ) +
                ifnull((select if(z.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
                from wk_finance_initial as w
                left join wk_finance_subject as z on z.subject_id = w.subject_id
                where w.subject_id = #{data.subjectId}
                and w.account_id = #{data.accountId}
                and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                #{data.accountId})
                ),0) > 0 then '借'
                ELSE '平'
                end as balance_direction ,
                abs((select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
                from wk_finance_certificate_detail as e
                left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
                where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= #{x}
                and e.account_id = #{data.accountId}
                and e.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                )+
                ifnull((select if(z.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
                from wk_finance_initial as w
                left join wk_finance_subject as z on z.subject_id = w.subject_id
                where w.subject_id = #{data.subjectId}
                and w.account_id = #{data.accountId}
                and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                #{data.accountId})
                ),0)) as balance
            </if>
            , '3' as `type`,#{x} as monthTime
            ,DATE_FORMAT(CONCAT(#{x},'01') ,'%Y') as yearTime
            union all
            select #{x} as account_time,
            null as certificate_num , '本年累计' as digest_content ,
            (select ifnull(sum(e.debtor_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= #{x}
            and DATE_FORMAT(c.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01') ,'%Y')
            and e.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) + if((select DATE_FORMAT(start_time,'%Y') from wk_finance_parameter
            where account_id = #{data.accountId}
            ) = DATE_FORMAT(CONCAT(#{x},'01'),'%Y'),ifnull((select sum(add_up_debtor_balance) from wk_finance_initial
            where subject_id = #{data.subjectId}
            and account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0),0 ) as debtor_balance,
            (select ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= #{x}
            and DATE_FORMAT(c.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01') ,'%Y')
            and e.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) + if((select DATE_FORMAT(start_time,'%Y') from wk_finance_parameter
            where account_id = #{data.accountId}
            ) = DATE_FORMAT(CONCAT(#{x},'01'),'%Y'),ifnull((select sum(add_up_credit_balance) from wk_finance_initial
            where subject_id = #{data.subjectId}
            and account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0),0 ) as credit_balance,
            <if test="data.accountBookDirection == 1">
                <if test="data.balanceDirection == 1">
                    if( (select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
                    from wk_finance_certificate_detail as e
                    left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
                    where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= #{x}
                    and c.account_id = #{data.accountId}
                    and e.subject_id in
                    <foreach collection="data.subjectIds" index="index" open="(" close=")" separator=","
                             item="subjectId">
                        #{subjectId}
                    </foreach>
                    ) +
                    ifnull((select if(y.balance_direction = 1,ifnull(sum(initial_balance),0),0-
                    ifnull(sum(initial_balance),0))
                    from wk_finance_subject as y
                    left join wk_finance_initial as w on y.subject_id = w.subject_id
                    where w.subject_id = #{data.subjectId}
                    and w.account_id = #{data.accountId}
                    and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                    #{data.accountId})
                    ),0) = 0,'平','借') as balance_direction,
                    (select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
                    from wk_finance_certificate_detail as e
                    left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
                    where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= #{x}
                    and c.account_id = #{data.accountId}
                    and e.subject_id in
                    <foreach collection="data.subjectIds" index="index" open="(" close=")" separator=","
                             item="subjectId">
                        #{subjectId}
                    </foreach>
                    ) +
                    ifnull((select if(y.balance_direction = 1,ifnull(sum(initial_balance),0),0-
                    ifnull(sum(initial_balance),0))
                    from wk_finance_subject as y
                    left join wk_finance_initial as w on y.subject_id = w.subject_id
                    where w.subject_id = #{data.subjectId}
                    and w.account_id = #{data.accountId}
                    and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                    #{data.accountId})
                    ),0) as balance
                </if>
                <if test="data.balanceDirection == 2">
                    if( (select ifnull(sum(e.credit_balance),0) - ifnull(sum(e.debtor_balance),0)
                    from wk_finance_certificate_detail as e
                    left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
                    where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= #{x}
                    and c.account_id = #{data.accountId}
                    and e.subject_id in
                    <foreach collection="data.subjectIds" index="index" open="(" close=")" separator=","
                             item="subjectId">
                        #{subjectId}
                    </foreach>
                    ) +
                    ifnull((select if(y.balance_direction = 2,ifnull(sum(initial_balance),0),0-
                    ifnull(sum(initial_balance),0))
                    from wk_finance_subject as y
                    left join wk_finance_initial as w on y.subject_id = w.subject_id
                    where w.subject_id = #{data.subjectId}
                    and w.account_id = #{data.accountId}
                    and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                    #{data.accountId})
                    ),0) = 0,'平','贷') as balance_direction,
                    (select ifnull(sum(e.credit_balance),0) - ifnull(sum(e.debtor_balance),0)
                    from wk_finance_certificate_detail as e
                    left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
                    where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= #{x}
                    and c.account_id = #{data.accountId}
                    and e.subject_id in
                    <foreach collection="data.subjectIds" index="index" open="(" close=")" separator=","
                             item="subjectId">
                        #{subjectId}
                    </foreach>
                    ) +
                    ifnull((select if(y.balance_direction = 2,ifnull(sum(initial_balance),0),0-
                    ifnull(sum(initial_balance),0))
                    from wk_finance_subject as y
                    left join wk_finance_initial as w on y.subject_id = w.subject_id
                    where w.subject_id = #{data.subjectId}
                    and w.account_id = #{data.accountId}
                    and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                    #{data.accountId})
                    ),0) as balance
                </if>
            </if>
            <if test="data.accountBookDirection == 2">
                case
                when (select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
                from wk_finance_certificate_detail as e
                left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
                where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= #{x}
                and DATE_FORMAT(c.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01') ,'%Y')
                and c.account_id = #{data.accountId}
                and e.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                )+ ifnull((select if(y.balance_direction = 1,ifnull(sum(initial_balance),0),0-
                ifnull(sum(initial_balance),0))
                from wk_finance_subject as y
                left join wk_finance_initial as w on y.subject_id = w.subject_id
                where w.subject_id = #{data.subjectId}
                and w.account_id = #{data.accountId}
                and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                #{data.accountId})
                ),0) &lt; 0 then '贷'
                when (select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
                from wk_finance_certificate_detail as e
                left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
                where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= #{x}
                and DATE_FORMAT(c.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01') ,'%Y')
                and c.account_id = #{data.accountId}
                and e.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                )+ ifnull((select if(y.balance_direction = 1,ifnull(sum(initial_balance),0),0-
                ifnull(sum(initial_balance),0))
                from wk_finance_subject as y
                left join wk_finance_initial as w on y.subject_id = w.subject_id
                where w.subject_id = #{data.subjectId}
                and w.account_id = #{data.accountId}
                and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                #{data.accountId})
                ),0) > 0 then '借'
                ELSE '平'
                end as balance_direction ,
                abs((select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
                from wk_finance_certificate_detail as e
                left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
                where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= #{x}
                and DATE_FORMAT(c.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01') ,'%Y')
                and e.account_id = #{data.accountId}
                and e.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                )+ifnull((select if(y.balance_direction = 1,ifnull(sum(initial_balance),0),0-
                ifnull(sum(initial_balance),0))
                from wk_finance_subject as y
                left join wk_finance_initial as w on y.subject_id = w.subject_id
                where w.subject_id = #{data.subjectId}
                and w.account_id = #{data.accountId}
                and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                #{data.accountId})
                ),0)) as balance
            </if>
            , '4' as `type`,#{x} as monthTime
            , DATE_FORMAT(CONCAT(#{x},'01') ,'%Y') as yearTime
        </foreach>
    </select>

    <select id="queryDebtorSubjectIds" resultType="java.lang.Long">
        select a.subject_id
        from wk_finance_certificate_detail as a
        left join wk_finance_certificate as b on a.certificate_id = b.certificate_id
        LEFT JOIN wk_finance_subject as c on a.subject_id = c.subject_id
        where DATE_FORMAT(b.certificate_time, '%Y%m') &lt;= #{data.endTime}
        and DATE_FORMAT(b.certificate_time, '%Y%m') >= #{data.startTime}
        and a.account_id = #{data.accountId}
        and c.parent_id = #{data.subjectId}
    </select>
    <select id="queryDiversification" resultType="com.alibaba.fastjson.JSONObject">
        select distinct DATE_ADD(#{data.startTime},interval -day(#{data.startTime})+1 day) as account_time,
        null as certificate_num , '期初余额' as digest_content , 0 as debtor_balance,
        0 as credit_balance,
        <if test="data.accountBookDirection == 1">
            if((select balance_direction from wk_finance_subject where subject_id = #{data.subjectId}) = 1,'借','贷') as
            balance_direction,
            case
            when (select balance_direction from wk_finance_subject where subject_id = #{data.subjectId}) = 1
            then (select ifnull(sum(c.debtor_balance),0) - ifnull(sum(c.credit_balance),0)
            from wk_finance_certificate_detail c
            left join wk_finance_certificate as a on c.certificate_id = a.certificate_id
            where DATE_FORMAT(a.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and c.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="id">
                #{id}
            </foreach>
            ) + ifnull((select sum(initial_balance)
            from wk_finance_initial as w
            where w.subject_id = #{data.subjectId}
            and w.account_id = #{data.accountId}
            ),0)
            else (select ifnull(sum(c.credit_balance),0) - ifnull(sum(c.debtor_balance),0)
            from wk_finance_certificate_detail c
            left join wk_finance_certificate as a on c.certificate_id = a.certificate_id
            where DATE_FORMAT(a.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and c.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="id">
                #{id}
            </foreach>
            ) + ifnull((select sum(initial_balance)
            from wk_finance_initial as w
            where w.subject_id = #{data.subjectId}
            and w.account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0)end as balance
        </if>
        <if test="data.accountBookDirection == 2">
            case
            when (select ifnull(sum(c.debtor_balance),0) - ifnull(sum(c.credit_balance),0)
            from wk_finance_certificate_detail c
            left join wk_finance_certificate as a on c.certificate_id = a.certificate_id
            where DATE_FORMAT(a.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and c.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="id">
                #{id}
            </foreach>
            ) + ifnull((select sum(initial_balance)
            from wk_finance_initial as w
            where w.subject_id = #{data.subjectId}
            and w.account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0) > 0 then '借'
            when (select ifnull(sum(c.debtor_balance),0) - ifnull(sum(c.credit_balance),0)
            from wk_finance_certificate_detail c
            left join wk_finance_certificate as a on c.certificate_id = a.certificate_id

            where DATE_FORMAT(a.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and c.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="id">
                #{id}
            </foreach>
            ) +ifnull((select sum(initial_balance)
            from wk_finance_initial as w
            where w.subject_id = #{data.subjectId}
            and w.account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0)= 0 then '平'
            else '贷'
            end as balance_direction,
            abs((select ifnull(sum(c.debtor_balance),0) - ifnull(sum(c.credit_balance),0)
            from wk_finance_certificate_detail c
            left join wk_finance_certificate as a on c.certificate_id = a.certificate_id
            where DATE_FORMAT(a.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and c.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="id">
                #{id}
            </foreach>
            )
            + ifnull((select sum(initial_balance)
            from wk_finance_initial as w
            where w.subject_id = #{data.subjectId}
            and w.account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0) ) as balance
        </if>
        , '1' as `type`,null as certificate_id,DATE_FORMAT(#{data.startTime},'%Y%m') as monthTime
        ,DATE_FORMAT(#{data.startTime},'%Y') as yearTime
        <if test="data.debtorSubjectIds.size() > 0">
            ,
            <foreach collection="data.debtorSubjectIds" index="index" separator="," item="id">
                (
                select if(v.balance_direction = 1,
                ifnull(sum(c.debtor_balance),0) - ifnull(sum(c.credit_balance),0),
                ifnull(sum(c.credit_balance),0) - ifnull(sum(c.debtor_balance),0))
                + ifnull((select sum(initial_balance)
                from wk_finance_initial as w
                where w.subject_id = #{id}
                and w.account_id = #{data.accountId}
                and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                #{data.accountId})
                ),0)
                from wk_finance_certificate_detail as c
                left join wk_finance_certificate as a on c.certificate_id = a.certificate_id
                left join wk_finance_subject as v on v.subject_id = c.subject_id
                where DATE_FORMAT(a.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
                and c.account_id = #{data.accountId}
                and c.subject_id = #{id}
                ) as `${id}`
            </foreach>
        </if>
        union all
        <foreach collection="data.timeList" item="x" separator="union all">
            select * from(
            select DATE_FORMAT(a.certificate_time,'%Y-%m-%d') as account_time,
            CONCAT(c.voucher_name,'_',a.certificate_num) as certificate_num ,b.digest_content,
            ifnull(b.debtor_balance,0) as debtor_balance,
            ifnull(b.credit_balance,0) as credit_balance ,
            <if test="data.accountBookDirection == 1">
                if(d.balance_direction = 1,'借','贷') as balance_direction,
                0 as balance
            </if>
            <if test="data.accountBookDirection == 2">
                null balance_direction,
                0 as balance
            </if>
            , '2' as `type`,a.certificate_id,DATE_FORMAT(a.certificate_time,'%Y%m') as monthTime
            ,DATE_FORMAT(a.certificate_time,'%Y') as yearTime
            <if test="data.debtorSubjectIds.size() > 0">
                ,
                <foreach collection="data.debtorSubjectIds" index="index" separator="," item="id">
                    (select if(v.balance_direction = 1,
                    ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0),
                    ifnull(sum(e.credit_balance),0) - ifnull(sum(e.debtor_balance),0))
                    from wk_finance_certificate_detail as e
                    left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
                    left join wk_finance_subject as v on v.subject_id = e.subject_id
                    where e.subject_id = #{id}
                    and DATE_FORMAT(c.certificate_time,'%Y%m') = #{x}
                    and c.account_id = #{data.accountId}
                    and e.detail_id = b.detail_id
                    )
                    as `${id}`
                </foreach>
            </if>
            from wk_finance_certificate_detail as b
            left join wk_finance_certificate as a on a.certificate_id = b.certificate_id
            left join wk_finance_voucher as c on a.voucher_id = c.voucher_id
            left join wk_finance_subject as d on b.subject_id = d.subject_id
            where DATE_FORMAT(a.certificate_time,'%Y%m') = #{x}
            and a.account_id = #{data.accountId}
            and b.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="id">
                #{id}
            </foreach>
            order by a.certificate_num
            ) as loiw
            union all
            select last_day(CONCAT(#{x},'01')) as account_time,
            null as certificate_num , '本期合计' as digest_content ,
            (select ifnull(sum(e.debtor_balance) ,0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as a on a.certificate_id = e.certificate_id
            where DATE_FORMAT(a.certificate_time,'%Y%m') = #{x}
            and a.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="id">
                #{id}
            </foreach>
            ) as debtor_balance,
            (select ifnull(sum(e.credit_balance) ,0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as a on a.certificate_id = e.certificate_id
            where DATE_FORMAT(a.certificate_time,'%Y%m') = #{x}
            and a.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="id">
                #{id}
            </foreach>
            ) as credit_balance,
            <if test="data.accountBookDirection == 1">
                if((select balance_direction from wk_finance_subject where subject_id = #{data.subjectId}) = 1,'借','贷')
                as balance_direction,
                0 as balance
            </if>
            <if test="data.accountBookDirection == 2">
                null as balance_direction,
                0 as balance
            </if>
            , '3' as `type`,null as certificate_id,#{x} as monthTime
            ,DATE_FORMAT(CONCAT(#{x},'01'),'%Y') as yearTime
            <if test="data.debtorSubjectIds.size() > 0">
                ,
                <foreach collection="data.debtorSubjectIds" index="index" separator="," item="id">
                    (select if(v.balance_direction = 1,
                    ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0),
                    ifnull(sum(e.credit_balance),0) - ifnull(sum(e.debtor_balance),0))
                    from wk_finance_certificate_detail as e
                    left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
                    left join wk_finance_subject as v on v.subject_id = e.subject_id
                    where e.subject_id = #{id}
                    and DATE_FORMAT(c.certificate_time,'%Y%m') = #{x}
                    and c.account_id = #{data.accountId}
                    )as `${id}`
                </foreach>
            </if>
            union all
            select last_day(CONCAT(#{x},'01')) as account_time,
            null as certificate_num , '本年累计' as digest_content ,
            (select ifnull(sum(e.debtor_balance) ,0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as a on a.certificate_id = e.certificate_id
            where DATE_FORMAT(a.certificate_time,'%Y%m') &lt;= #{x}
            and DATE_FORMAT(a.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01'),'%Y')
            and a.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="id">
                #{id}
            </foreach>
            ) + if((select DATE_FORMAT(start_time,'%Y') from wk_finance_parameter
            where account_id = #{data.accountId}
            ) = DATE_FORMAT(CONCAT(#{x},'01'),'%Y'),ifnull((select sum(add_up_debtor_balance) from wk_finance_initial
            where subject_id = #{data.subjectId}
            and account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0),0 ) as debtor_balance,
            (select ifnull(sum(e.credit_balance) ,0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as a on a.certificate_id = e.certificate_id
            where DATE_FORMAT(a.certificate_time,'%Y%m') &lt;= #{x}
            and DATE_FORMAT(a.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01'),'%Y')
            and a.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="id">
                #{id}
            </foreach>
            ) + if((select DATE_FORMAT(start_time,'%Y') from wk_finance_parameter
            where account_id = #{data.accountId}
            ) = DATE_FORMAT(CONCAT(#{x},'01'),'%Y'),ifnull((select sum(add_up_credit_balance) from wk_finance_initial
            where subject_id = #{data.subjectId}
            and account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0),0 ) as credit_balance,
            <if test="data.accountBookDirection == 1">
                if((select balance_direction from wk_finance_subject where subject_id = #{data.subjectId}) = 1,'借','贷')
                as balance_direction,
                0 as balance
            </if>
            <if test="data.accountBookDirection == 2">
                null as balance_direction,
                0 as balance
            </if>
            , '4' as `type`,null as certificate_id,#{x} as monthTime
            ,DATE_FORMAT(CONCAT(#{x},'01'),'%Y') as yearTime
            <if test="data.debtorSubjectIds.size() > 0">
                ,
                <foreach collection="data.debtorSubjectIds" index="index" separator="," item="id">
                    (select if(v.balance_direction = 1,
                    if((select DATE_FORMAT(start_time,'%Y') from wk_finance_parameter
                    where account_id = #{data.accountId}
                    ) = DATE_FORMAT(CONCAT(#{x},'01'),'%Y'),(select ifnull(sum(add_up_debtor_balance),0) -
                    ifnull(sum(add_up_credit_balance),0) from wk_finance_initial
                    where subject_id = #{id}
                    and account_id = #{data.accountId}
                    and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                    #{data.accountId})
                    )+ ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0),ifnull(sum(e.debtor_balance),0)
                    - ifnull(sum(e.credit_balance),0)),
                    if((select DATE_FORMAT(start_time,'%Y') from wk_finance_parameter
                    where account_id = #{data.accountId}
                    ) = DATE_FORMAT(CONCAT(#{x},'01'),'%Y'),(select ifnull(sum(add_up_credit_balance),0) -
                    ifnull(sum(add_up_debtor_balance),0) from wk_finance_initial
                    where subject_id = #{id}
                    and account_id = #{data.accountId}
                    and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                    #{data.accountId})
                    ) + ifnull(sum(e.credit_balance),0) -
                    ifnull(sum(e.debtor_balance),0),ifnull(sum(e.credit_balance),0) - ifnull(sum(e.debtor_balance),0)))
                    from wk_finance_certificate_detail as e
                    left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
                    left join wk_finance_subject as v on v.subject_id = e.subject_id
                    where e.subject_id = #{id}
                    and DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= #{x}
                    and DATE_FORMAT(c.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01'),'%Y')
                    and c.account_id = #{data.accountId}
                    )as `${id}`
                </foreach>
            </if>
            union all
            select distinct last_day(CONCAT(#{x},'01')) as account_time,
            null as certificate_num , '期末余额' as digest_content , 0 as debtor_balance,
            null as credit_balance,
            <if test="data.accountBookDirection == 1">
                if((select balance_direction from wk_finance_subject where subject_id = #{data.subjectId}) = 1,'借','贷')
                as balance_direction,
                if((select DATE_FORMAT(start_time,'%Y%m') from wk_finance_parameter
                where account_id = #{data.accountId}
                ) = DATE_FORMAT(#{data.startTime},'%Y%m'),ifnull((select sum(initial_balance)
                from wk_finance_initial as w
                where w.subject_id = #{data.subjectId}
                and w.account_id = #{data.accountId}
                and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                #{data.accountId})
                ),0),if((select balance_direction from wk_finance_subject where subject_id = #{data.subjectId}) = 1,
                0,0)) as balance
            </if>
            <if test="data.accountBookDirection == 2">
                null as balance_direction,
                0 as balance
            </if>
            , '5' as `type`,null as certificate_id,#{x} as monthTime
            ,DATE_FORMAT(#{data.startTime},'%Y') as yearTime
            <if test="data.debtorSubjectIds.size() > 0">
                ,
                <foreach collection="data.debtorSubjectIds" index="index" separator="," item="id">
                    (select if(v.balance_direction = 1,
                    ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0),
                    ifnull(sum(e.credit_balance),0) - ifnull(sum(e.debtor_balance),0))
                    + ifnull((select sum(initial_balance)
                    from wk_finance_initial as w
                    where w.subject_id = #{id}
                    and w.account_id = #{data.accountId}
                    and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                    #{data.accountId})
                    ),0)
                    from wk_finance_certificate_detail as e
                    left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
                    left join wk_finance_subject as v on v.subject_id = e.subject_id
                    where e.subject_id = #{id}
                    and DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= #{x}
                    and c.account_id = #{data.accountId}
                    )
                    as `${id}`
                </foreach>
            </if>
            from wk_finance_certificate as a
            where DATE_FORMAT(a.certificate_time,'%Y%m') &lt;= #{x}
            and a.account_id = #{data.accountId}
        </foreach>
    </select>
    <select id="queryListDetailBalanceAccount" resultType="com.alibaba.fastjson.JSONObject">
        select f.*,
        case
        when f.balance_direction = 2
        then (f.credit_initial_balance + f.credit_current_balance - f.debtor_current_balance )
        ELSE 0
        end as credit_end_balance,
        case
        when f.balance_direction = 1
        then (f.debtor_initial_balance + f.debtor_current_balance - f.credit_current_balance )
        ELSE 0
        end as debtor_end_balance,
        case
        when f.balance_direction = 1
        then (f.debtor_initial_balance + f.debtor_current_balance - f.credit_current_balance )
        ELSE (f.credit_initial_balance + f.credit_current_balance - f.debtor_current_balance )
        end as end_balance
        <if test="data.isFlat == 1">
            , (f.debtor_current_balance - f.credit_current_balance) as debtor_current_end_balance
            , (f.credit_current_balance - f.debtor_current_balance) as credit_current_end_balance
        </if>
        from (
        select distinct
        if(a.balance_direction = 2,(select ifnull(sum(d.credit_balance),0) - ifnull(sum(d.debtor_balance),0)
        from wk_finance_certificate_detail as d
        left join wk_finance_certificate as c on d.certificate_id = c.certificate_id
        where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; #{data.startTime}
        and d.subject_id = a.subject_id
        and c.account_id = #{data.accountId}
        )+ if((select DATE_FORMAT(start_time,'%Y%m') from wk_finance_parameter
        where account_id = #{data.accountId}) = #{data.startTime},
        ifnull((select sum(initial_balance) from wk_finance_initial as z
        left join wk_finance_subject as w on z.subject_id = w.subject_id
        where z.subject_id = a.subject_id
        and z.account_id = #{data.accountId}
        and initial_id not in (select initial_id from wk_finance_initial_assist where account_id = #{data.accountId})
        ),0),0),0) as credit_initial_balance,
        if(a.balance_direction = 1,(select ifnull(sum(d.debtor_balance),0) - ifnull(sum(d.credit_balance),0)
        from wk_finance_certificate_detail as d
        left join wk_finance_certificate as c on d.certificate_id = c.certificate_id
        where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; #{data.startTime}
        and d.subject_id = a.subject_id
        and c.account_id = #{data.accountId}
        )+ if((select DATE_FORMAT(start_time,'%Y%m') from wk_finance_parameter
        where account_id = #{data.accountId}) = #{data.startTime},
        ifnull((select sum(initial_balance) from wk_finance_initial as z
        left join wk_finance_subject as w on z.subject_id = w.subject_id
        where z.subject_id = a.subject_id
        and z.account_id = #{data.accountId}
        and initial_id not in (select initial_id from wk_finance_initial_assist where account_id = #{data.accountId})
        ),0),0),0) as debtor_initial_balance,
        (select ifnull(sum(d.credit_balance),0)
        from wk_finance_certificate_detail as d
        left join wk_finance_certificate as c on d.certificate_id = c.certificate_id
        where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= #{data.endTime}
        and DATE_FORMAT(c.certificate_time,'%Y%m') >= #{data.startTime}
        and d.subject_id = a.subject_id
        and c.account_id = #{data.accountId}
        ) as credit_current_balance,
        (select ifnull(sum(d.debtor_balance),0)
        from wk_finance_certificate_detail as d
        left join wk_finance_certificate as c on d.certificate_id = c.certificate_id
        where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= #{data.endTime}
        and DATE_FORMAT(c.certificate_time,'%Y%m') >= #{data.startTime}
        and d.subject_id = a.subject_id
        and c.account_id = #{data.accountId}
        ) as debtor_current_balance,
        (select ifnull(sum(d.credit_balance),0)
        from wk_finance_certificate_detail as d
        left join wk_finance_certificate as c on d.certificate_id = c.certificate_id
        where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= #{data.endTime}
        and DATE_FORMAT(c.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{data.endTime},'01'),'%Y')
        and d.subject_id = a.subject_id
        and c.account_id = #{data.accountId}
        ) as credit_year_balance,
        (select ifnull(sum(d.debtor_balance),0)
        from wk_finance_certificate_detail as d
        left join wk_finance_certificate as c on d.certificate_id = c.certificate_id
        where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= #{data.endTime}
        and DATE_FORMAT(c.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{data.endTime},'01'),'%Y')
        and d.subject_id = a.subject_id
        and c.account_id = #{data.accountId}
        ) as debtor_year_balance,a.balance_direction,
        a.subject_id,a.subject_name,a.number
        from wk_finance_subject as a
        where a.subject_id in
        <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
            #{subjectId}
        </foreach>
        and a.account_id = #{data.accountId}
        ) as f
        <if test="data.isFlat == 1">
            where (f.debtor_current_balance - f.credit_current_balance) != 0
        </if>
    </select>
    <select id="queryByTime" resultType="com.kakarote.finance.entity.PO.FinanceCertificate">
        select *
        from wk_finance_certificate
        where voucher_id = #{data.voucherId}
        <if test="data.certificateNum != null and data.certificateNum != ''">
            and certificate_num = #{data.certificateNum}
        </if>
        and DATE_FORMAT(certificate_time,'%Y%m') = DATE_FORMAT(#{data.certificateTime},'%Y%m')
        <if test="data.certificateId != null and data.certificateId != ''">
            and certificate_id != #{data.certificateId}
        </if>
        order by certificate_num desc
    </select>
    <select id="queryCertificate" resultType="com.kakarote.finance.entity.PO.FinanceCertificate">
        select *
        from wk_finance_certificate
        where voucher_id = #{data.voucherId}
        and certificate_num = #{data.moveCertificateNum}
        and DATE_FORMAT(certificate_time, '%Y%m') = #{data.certificateTime}
    </select>
    <select id="queryCertificateTime" resultType="com.alibaba.fastjson.JSONObject">
        select ifnull((select DATE_FORMAT(certificate_time, '%Y-%m')
        from wk_finance_certificate
        where certificate_time is not null
        and account_id = #{accountId}
        ORDER BY certificate_time
        LIMIT 0,1),
        (select DATE_FORMAT(start_time, '%Y-%m')
        from wk_finance_parameter
        where account_id = #{accountId})) as minTime,
        ifnull((select DATE_FORMAT(certificate_time, '%Y-%m')
        from wk_finance_certificate
        where certificate_time is not null
        and account_id = #{accountId}
        ORDER BY certificate_time desc
        LIMIT 0,1),
        (select DATE_FORMAT(start_time, '%Y-%m')
        from wk_finance_parameter
        where account_id = #{accountId})) as maxTime
    </select>
    <select id="queryListByNum" resultType="com.kakarote.finance.entity.PO.FinanceCertificate">
        select *
        from wk_finance_certificate
        where voucher_id = #{data.voucherId}
        and account_id = #{data.accountId}
        <if test="data.certificateNum != null and data.certificateNum != ''">
            and certificate_num >= #{data.certificateNum}
        </if>
        and DATE_FORMAT(certificate_time,'%Y%m') = #{data.settleTime}
        <if test="data.type == 1">
            order by certificate_num
        </if>
        <if test="data.type == 2">
            order by certificate_time
        </if>
    </select>
    <select id="queryBalanceByIds" resultType="java.lang.Integer">
        select if(ifnull(sum(debtor_balance),0) -ifnull(sum(credit_balance),0) = 0,1,0 )
        from wk_finance_certificate_detail
        where account_id = #{accountId}
        and certificate_id in
        <foreach collection="ids" index="index" open="(" close=")" separator="," item="id">
            #{id}
        </foreach>
    </select>
    <update id="updateCertificate">
        update wk_finance_certificate set certificate_num = certificate_num + 1
        where voucher_id = #{data.voucherId}
        <if test="data.moveCertificateNum != null and data.moveCertificateNum != ''">
            and certificate_num != #{data.moveCertificateNum}
            and certificate_num &lt; #{data.moveCertificateNum}
        </if>
        <if test="data.insertCertificateNum != null and data.insertCertificateNum != ''">
            and certificate_num >= #{data.insertCertificateNum}
        </if>
        and DATE_FORMAT(certificate_time,'%Y%m') = #{data.certificateTime}
    </update>

    <select id="queryCurrentBalance" resultType="com.alibaba.fastjson.JSONObject">
        select a.*
        from (
        SELECT IFNULL(SUM(b.debtor_balance), 0) AS debtor_current_balance,
        IFNULL(SUM(b.credit_balance), 0) AS credit_current_balance,
        DATE_FORMAT(a.certificate_time, '%Y%m') as period,
        b.subject_id,
        b.subject_number
        FROM wk_finance_certificate a
        INNER JOIN wk_finance_certificate_detail b
        ON a.certificate_id = b.certificate_id
        WHERE a.account_id = #{accountId}
        AND (DATE_FORMAT(a.certificate_time, '%Y%m') >= #{fromPeriod}
        AND DATE_FORMAT(a.certificate_time, '%Y%m') &lt;= #{toPeriod})
        GROUP BY b.subject_id, DATE_FORMAT(a.certificate_time, '%Y%m')
        ) a
        order by subject_number
    </select>

    <select id="queryCurrentBalanceNoSettle" resultType="com.alibaba.fastjson.JSONObject">
        select a.*
        from (
        SELECT IFNULL(SUM(
        if(e.type = 5 and d.statement_type = 2, 0,
        b.debtor_balance)
        ), 0) AS debtorCurrentBalance,
        IFNULL(SUM(
        if(e.type = 5 and d.statement_type = 2, 0,
        b.credit_balance)
        ), 0) AS creditCurrentBalance,
        DATE_FORMAT(a.certificate_time, '%Y%m') as period,
        b.subject_id,
        e.number
        FROM wk_finance_certificate a
        INNER JOIN wk_finance_certificate_detail b
        ON a.certificate_id = b.certificate_id
        LEFT JOIN wk_finance_statement_certificate c
        ON c.certificate_id = b.certificate_id
        LEFT JOIN wk_finance_statement d ON c.statement_id = d.statement_id
        LEFT JOIN wk_finance_subject e on b.subject_id = e.subject_id
        WHERE a.account_id = #{accountId}
        AND (DATE_FORMAT(a.certificate_time, '%Y%m') >= #{fromPeriod}
        AND DATE_FORMAT(a.certificate_time, '%Y%m') &lt;= #{toPeriod})
        GROUP BY b.subject_id, DATE_FORMAT(a.certificate_time, '%Y%m')
        ) a
        order by number
    </select>

    <select id="queryAccumulatedAmount" resultType="com.alibaba.fastjson.JSONObject">
        select a.subject_id,
        a.number,
        a.subject_name,
        a.balance_direction,
        a.grade,
        null assist_id,
        IFNULL(b.debtorCurrentBalance, 0) AS debtorCurrentBalance,
        IFNULL(b.creditCurrentBalance, 0) AS creditCurrentBalance,
        false isAssist
        from wk_finance_subject a
        left join
        (SELECT IFNULL(SUM(b.debtor_balance), 0) AS debtorCurrentBalance,
        IFNULL(SUM(b.credit_balance), 0) AS creditCurrentBalance,
        b.subject_id
        FROM wk_finance_certificate a
        LEFT JOIN wk_finance_certificate_detail b
        ON a.certificate_id = b.certificate_id
        WHERE a.account_id = #{accountId}
        AND b.assist_id is null
        AND (DATE_FORMAT(a.certificate_time, '%Y%m') >= #{fromPeriod}
        AND DATE_FORMAT(a.certificate_time, '%Y%m') &lt;= #{toPeriod})
        GROUP BY b.subject_id) b on a.subject_id = b.subject_id
        WHERE a.account_id = #{accountId}
        order by number
    </select>

    <select id="queryAccumulatedAmountNoSettle" resultType="com.alibaba.fastjson.JSONObject">
        select a.subject_id,
        a.number,
        a.subject_name,
        a.balance_direction,
        a.grade,
        null assist_id,
        IFNULL(b.debtorCurrentBalance, 0) AS debtorCurrentBalance,
        IFNULL(b.creditCurrentBalance, 0) AS creditCurrentBalance,
        false isAssist
        from wk_finance_subject a
        left join
        (SELECT IFNULL(SUM(
        if(e.type = 5 and d.statement_type = 2, 0,
        b.debtor_balance)
        ), 0) AS debtorCurrentBalance,
        IFNULL(SUM(
        if(e.type = 5 and d.statement_type = 2, 0,
        b.credit_balance)
        ), 0) AS creditCurrentBalance,
        b.subject_id
        FROM wk_finance_certificate a
        LEFT JOIN wk_finance_certificate_detail b
        ON a.certificate_id = b.certificate_id
        LEFT JOIN wk_finance_statement_certificate c
        ON c.certificate_id = b.certificate_id
        LEFT JOIN wk_finance_statement d ON c.statement_id = d.statement_id
        LEFT JOIN wk_finance_subject e on b.subject_id = e.subject_id
        WHERE a.account_id = #{accountId}
        AND (DATE_FORMAT(a.certificate_time, '%Y%m') >= #{fromPeriod}
        AND DATE_FORMAT(a.certificate_time, '%Y%m') &lt;= #{toPeriod})
        GROUP BY b.subject_id) b on a.subject_id = b.subject_id
        WHERE a.account_id = #{accountId}
        order by number
    </select>

    <select id="queryAccumulatedAmountAssist" resultType="com.alibaba.fastjson.JSONObject">
        select b.subject_id,
        b.assist_id,
        IFNULL(SUM(c.debtor_balance), 0) AS debtor_current_balance,
        IFNULL(SUM(c.credit_balance), 0) AS credit_current_balance,
        true isAssist
        from wk_finance_assist b
        left join wk_finance_certificate_detail c on c.subject_id = b.subject_id and c.assist_id = b.assist_id
        left join wk_finance_certificate as d on d.certificate_id = c.certificate_id
        where b.account_id = #{accountId}
        and b.assist_id is not null
        AND (DATE_FORMAT(d.certificate_time, '%Y%m') >= #{fromPeriod}
        AND DATE_FORMAT(d.certificate_time, '%Y%m') &lt;= #{toPeriod})
        GROUP BY b.assist_id
    </select>

    <select id="querySubjectIds2" resultType="java.lang.Long">
        select a.subject_id
        from wk_finance_certificate_detail as a
        left join wk_finance_certificate as b on a.certificate_id = b.certificate_id
        where a.account_id = #{data.accountId}
        and a.subject_id is not null
        and DATE_FORMAT(b.certificate_time,'%Y%m') >= #{data.startTime}
        and DATE_FORMAT(b.certificate_time,'%Y%m') &lt;= #{data.endTime}
        <if test="data.minCertificateNum != null and data.minCertificateNum != ''">
            and b.certificate_num >= #{data.minCertificateNum}
        </if>
        <if test="data.maxCertificateNum != null and data.maxCertificateNum != ''">
            and b.certificate_num &lt;= #{data.maxCertificateNum}
        </if>
        <if test="data.voucherId != null and data.voucherId != ''">
            and b.voucher_id = #{data.voucherId}
        </if>
    </select>
    <select id="queryAmountDetailAccount" resultType="com.alibaba.fastjson.JSONObject">
        select distinct last_day(DATE_FORMAT(#{data.startTime},'%Y-%m-%d')) as account_time,
        null as certificate_num , '期初余额' as digest_content , 0 as debtor_balance,
        0 as credit_balance,
        <if test="data.accountBookDirection == 2">
            case
            when
            ( (select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and e.assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
            </if>
            ) +
            ifnull((select if(z.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial as w
            left join wk_finance_subject as z on z.subject_id = w.subject_id
            where
            w.account_id = #{data.accountId}
            <if test="data.assistIds == null or data.assistIds.size == 0">
                and w.subject_id = #{data.subjectId}
                and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                #{data.accountId})
            </if>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and initial_id in
                (select initial_id from wk_finance_initial_assist where account_id = #{data.accountId}
                and finance_assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
                )
            </if>
            ),0)
            ) > 0 then '借'
            when ( (select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and e.assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
            </if>
            ) +
            ifnull((select if(z.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial as w
            left join wk_finance_subject as z on z.subject_id = w.subject_id
            where w.account_id = #{data.accountId}
            <if test="data.assistIds == null or data.assistIds.size == 0">
                and w.subject_id = #{data.subjectId}
                and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                #{data.accountId})
            </if>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and initial_id in
                (select initial_id from wk_finance_initial_assist where account_id = #{data.accountId}
                and finance_assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
                )
            </if>
            ),0)) &lt; 0 then '贷'
            else '平'
            end as balance_direction,
            abs(( (select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and e.assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
            </if>
            ) +
            ifnull((select if(z.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial as w
            left join wk_finance_subject as z on z.subject_id = w.subject_id
            where w.account_id = #{data.accountId}
            <if test="data.assistIds == null or data.assistIds.size == 0">
                and w.subject_id = #{data.subjectId}
                and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                #{data.accountId})
            </if>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and initial_id in
                (select initial_id from wk_finance_initial_assist where account_id = #{data.accountId}
                and finance_assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
                )
            </if>
            ),0))) as balance,
            abs(( (select if(e.debtor_balance is not null and e.debtor_balance != 0,ifnull(sum(e.quantity),0),0)
            - if(e.credit_balance is not null and e.credit_balance != 0,ifnull(sum(e.quantity),0),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and e.assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
            </if>
            ) +
            ifnull((select if(z.balance_direction = 1,sum(initial_num),0 - sum(initial_num))
            from wk_finance_initial as w
            left join wk_finance_subject as z on z.subject_id = w.subject_id
            where w.account_id = #{data.accountId}
            <if test="data.assistIds == null or data.assistIds.size == 0">
                and w.subject_id = #{data.subjectId}
                and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                #{data.accountId})
            </if>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and initial_id in
                (select initial_id from wk_finance_initial_assist where account_id = #{data.accountId}
                and finance_assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
                )
            </if>
            ),0))) as balance_quantity
        </if>
        <if test="data.accountBookDirection == 1">
            if((select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and e.assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
            </if>
            ) +
            ifnull((select if(z.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial as w
            left join wk_finance_subject as z on z.subject_id = w.subject_id
            where w.account_id = #{data.accountId}
            <if test="data.assistIds == null or data.assistIds.size == 0">
                and w.subject_id = #{data.subjectId}
                and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                #{data.accountId})
            </if>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and initial_id in
                (select initial_id from wk_finance_initial_assist where account_id = #{data.accountId}
                and finance_assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
                )
            </if>
            ),0) = 0,'平',if((select balance_direction from wk_finance_subject where subject_id = #{data.subjectId}) =
            1,'借','贷') )
            as balance_direction,
            if((select balance_direction from wk_finance_subject where subject_id = #{data.subjectId}) = 1,
            (select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and e.assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
            </if>
            ) +
            ifnull((select if(z.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial as w
            left join wk_finance_subject as z on z.subject_id = w.subject_id
            where w.account_id = #{data.accountId}
            <if test="data.assistIds == null or data.assistIds.size == 0">
                and w.subject_id = #{data.subjectId}
                and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                #{data.accountId})
            </if>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and initial_id in
                (select initial_id from wk_finance_initial_assist where account_id = #{data.accountId}
                and finance_assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
                )
            </if>
            ),0), (select ifnull(sum(e.credit_balance),0) - ifnull(sum(e.debtor_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and e.assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
            </if>
            ) +
            ifnull((select if(z.balance_direction = 2,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial as w
            left join wk_finance_subject as z on z.subject_id = w.subject_id
            where w.account_id = #{data.accountId}
            <if test="data.assistIds == null or data.assistIds.size == 0">
                and w.subject_id = #{data.subjectId}
                and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                #{data.accountId})
            </if>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and initial_id in
                (select initial_id from wk_finance_initial_assist where account_id = #{data.accountId}
                and finance_assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
                )
            </if>
            ),0)) as balance,
            if((select balance_direction from wk_finance_subject where subject_id = #{data.subjectId}) = 1,
            (select if(e.debtor_balance is not null and e.debtor_balance != 0,ifnull(sum(e.quantity),0),0)
            - if(e.credit_balance is not null and e.credit_balance != 0,ifnull(sum(e.quantity),0),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and e.assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
            </if>
            ) +
            ifnull((select if(z.balance_direction = 1,sum(initial_num),0 - sum(initial_num))
            from wk_finance_initial as w
            left join wk_finance_subject as z on z.subject_id = w.subject_id
            where w.account_id = #{data.accountId}
            <if test="data.assistIds == null or data.assistIds.size == 0">
                and w.subject_id = #{data.subjectId}
                and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                #{data.accountId})
            </if>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and initial_id in
                (select initial_id from wk_finance_initial_assist where account_id = #{data.accountId}
                and finance_assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
                )
            </if>
            ),0), (select if(e.credit_balance is not null and e.credit_balance != 0,ifnull(sum(e.quantity),0),0)
            - if(e.debtor_balance is not null and e.debtor_balance != 0,ifnull(sum(e.quantity),0),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and e.assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
            </if>
            ) +
            ifnull((select if(z.balance_direction = 2,sum(initial_num),0 - sum(initial_num))
            from wk_finance_initial as w
            left join wk_finance_subject as z on z.subject_id = w.subject_id
            where w.account_id = #{data.accountId}
            <if test="data.assistIds == null or data.assistIds.size == 0">
                and w.subject_id = #{data.subjectId}
                and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                #{data.accountId})
            </if>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and initial_id in
                (select initial_id from wk_finance_initial_assist where account_id = #{data.accountId}
                and finance_assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
                )
            </if>
            ),0)) as balance_quantity
        </if>
        , '1' as `type`,null as certificate_id,DATE_FORMAT(#{data.startTime},'%Y%m') as monthTime
        ,DATE_FORMAT(#{data.startTime},'%Y') as yearTime,
        null as debtor_quantity,null as credit_quantity,null as debtor_amount_unit,null as credit_amount_unit,
        null as balance_amount_unit
        union all
        <foreach collection="data.timeList" item="x" separator="union all">
            select *
            from(
            select DATE_FORMAT(a.certificate_time,'%Y-%m-%d') as account_time,
            CONCAT(c.voucher_name,'_',a.certificate_num) as certificate_num ,b.digest_content,
            ifnull(b.debtor_balance,0) as debtor_balance,
            ifnull(b.credit_balance,0) as credit_balance ,
            <if test="data.accountBookDirection == 1">
                if(d.balance_direction = 1,'借','贷') as balance_direction,
                if(d.balance_direction = 1,ifnull((select ifnull(sum(e.debtor_balance),0) -
                ifnull(sum(e.credit_balance),0)
                from wk_finance_certificate_detail as e
                left join wk_finance_certificate as w on e.certificate_id = w.certificate_id
                where DATE_FORMAT(w.certificate_time,'%Y%m') &lt;= #{x}
                and e.account_id = #{data.accountId}
                and e.subject_id = b.subject_id
                <if test="data.assistIds != null and data.assistIds.size > 0">
                    and e.assist_id in
                    <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                        #{assistId}
                    </foreach>
                </if>
                ),0), ifnull((select ifnull(sum(e.credit_balance),0) - ifnull(sum(e.debtor_balance),0)
                from wk_finance_certificate_detail as e
                left join wk_finance_certificate as w on e.certificate_id = w.certificate_id
                where DATE_FORMAT(w.certificate_time,'%Y%m') &lt;= #{x}
                and e.account_id = #{data.accountId}
                and e.subject_id = b.subject_id
                <if test="data.assistIds != null and data.assistIds.size > 0">
                    and e.assist_id in
                    <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                        #{assistId}
                    </foreach>
                </if>
                ),0)) as balance
                ,
                null as balance_quantity
            </if>
            <if test="data.accountBookDirection == 2">
                case
                when (ifnull(b.debtor_balance,0) - ifnull(b.credit_balance,0)+
                ifnull((select sum(initial_balance) from wk_finance_initial
                where subject_id = b.subject_id
                and account_id = #{data.accountId}
                <if test="data.assistIds == null or data.assistIds.size == 0">
                    and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                    #{data.accountId})
                </if>
                <if test="data.assistIds != null and data.assistIds.size > 0">
                    and initial_id in
                    (select initial_id from wk_finance_initial_assist where account_id = #{data.accountId}
                    and assist_id in
                    <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                        #{assistId}
                    </foreach>
                    )
                </if>
                ),0)) > 0 then '借'
                when (ifnull(b.debtor_balance,0) - ifnull(b.credit_balance,0)+
                ifnull((select sum(initial_balance) from wk_finance_initial
                where subject_id = b.subject_id
                and account_id = #{data.accountId}
                <if test="data.assistIds == null or data.assistIds.size == 0">
                    and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                    #{data.accountId})
                </if>
                <if test="data.assistIds != null and data.assistIds.size > 0">
                    and initial_id in
                    (select initial_id from wk_finance_initial_assist where account_id = #{data.accountId}
                    and assist_id in
                    <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                        #{assistId}
                    </foreach>
                    )
                </if>
                ),0)) = 0 then '平'
                else '贷'
                end as balance_direction,
                abs(ifnull(b.debtor_balance,0) - ifnull(b.credit_balance,0)) as balance
                ,
                null as balance_quantity
            </if>
            , '2' as `type`,a.certificate_id,DATE_FORMAT(a.certificate_time,'%Y%m') as monthTime
            ,DATE_FORMAT(a.certificate_time,'%Y') as yearTime,
            if(ifnull(b.debtor_balance,0) > 0,if(quantity is null or quantity = '',0,quantity),0) as debtor_quantity,
            if(ifnull(b.credit_balance,0) > 0,if(quantity is null or quantity = '',0,quantity),0) as credit_quantity,
            if(ifnull(b.debtor_balance,0) > 0,b.debtor_balance/quantity,0) as debtor_amount_unit,
            if(ifnull(b.credit_balance,0) > 0,b.credit_balance/quantity,0) as credit_amount_unit,
            null as balance_amount_unit
            from wk_finance_certificate_detail as b
            left join wk_finance_certificate as a on a.certificate_id = b.certificate_id
            left join wk_finance_voucher as c on a.voucher_id = c.voucher_id
            left join wk_finance_subject as d on b.subject_id = d.subject_id
            where DATE_FORMAT(a.certificate_time,'%Y%m') = #{x}
            and a.account_id = #{data.accountId}
            and b.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and b.assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
            </if>
            order by a.certificate_time
            ) as lict

            union all
            select last_day(DATE_FORMAT(CONCAT(#{x},'01'),'%Y-%m-%d')) as account_time,
            null as certificate_num , '本期合计' as digest_content ,
            (select ifnull(sum(b.debtor_balance),0)
            from wk_finance_certificate_detail as b
            left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
            where DATE_FORMAT(a.certificate_time,'%Y%m') = #{x}
            and a.account_id = #{data.accountId}
            and b.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and b.assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
            </if>
            ) as debtor_balance,
            (select ifnull(sum(b.credit_balance),0)
            from wk_finance_certificate_detail as b
            left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
            where DATE_FORMAT(a.certificate_time,'%Y%m') = #{x}
            and a.account_id = #{data.accountId}
            and b.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and b.assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
            </if>
            ) as credit_balance,
            <if test="data.accountBookDirection == 1">
                if( (select ifnull(sum(b.debtor_balance),0) - ifnull(sum(b.credit_balance),0)
                from wk_finance_certificate_detail as b
                left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
                where DATE_FORMAT(a.certificate_time,'%Y%m') = #{x}
                and a.account_id = #{data.accountId}
                and b.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                <if test="data.assistIds != null and data.assistIds.size > 0">
                    and b.assist_id in
                    <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                        #{assistId}
                    </foreach>
                </if>
                ) +
                if((select DATE_FORMAT(start_time,'%Y%m') from wk_finance_parameter
                where account_id = #{data.accountId}
                ) = DATE_FORMAT(#{x},'%Y%m'),ifnull((select sum(initial_balance) from wk_finance_initial
                where subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                and account_id = #{data.accountId}
                <if test="data.assistIds == null or data.assistIds.size == 0">
                    and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                    #{data.accountId})
                </if>
                <if test="data.assistIds != null and data.assistIds.size > 0">
                    and initial_id in
                    (select initial_id from wk_finance_initial_assist where account_id = #{data.accountId}
                    and assist_id in
                    <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                        #{assistId}
                    </foreach>
                    )
                </if>
                ),0),0 ) = 0,'平','借') as balance_direction,
                (select ifnull(sum(b.debtor_balance),0) - ifnull(sum(b.credit_balance),0)
                from wk_finance_certificate_detail as b
                left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
                where DATE_FORMAT(a.certificate_time,'%Y%m') = #{x}
                and a.account_id = #{data.accountId}
                and b.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                <if test="data.assistIds != null and data.assistIds.size > 0">
                    and b.assist_id in
                    <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                        #{assistId}
                    </foreach>
                </if>
                ) +
                if((select DATE_FORMAT(start_time,'%Y%m') from wk_finance_parameter
                where account_id = #{data.accountId}
                ) = DATE_FORMAT(#{x},'%Y%m'),ifnull((select sum(initial_balance) from wk_finance_initial
                where subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                and account_id = #{data.accountId}
                <if test="data.assistIds == null or data.assistIds.size == 0">
                    and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                    #{data.accountId})
                </if>
                <if test="data.assistIds != null and data.assistIds.size > 0">
                    and initial_id in
                    (select initial_id from wk_finance_initial_assist where account_id = #{data.accountId}
                    and assist_id in
                    <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                        #{assistId}
                    </foreach>
                    )
                </if>
                ),0),0 ) as balance
                ,
                null as balance_quantity
            </if>
            <if test="data.accountBookDirection == 2">
                case
                when (select ifnull(sum(b.debtor_balance),0) - ifnull(sum(b.credit_balance),0)
                from wk_finance_certificate_detail as b
                left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
                where DATE_FORMAT(a.certificate_time,'%Y%m') = #{x}
                and a.account_id = #{data.accountId}
                and b.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                <if test="data.assistIds != null and data.assistIds.size > 0">
                    and b.assist_id in
                    <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                        #{assistId}
                    </foreach>
                </if>
                )+
                if((select DATE_FORMAT(start_time,'%Y%m') from wk_finance_parameter
                where account_id = #{data.accountId}
                ) = DATE_FORMAT(#{x},'%Y%m'),ifnull((select sum(initial_balance) from wk_finance_initial
                where subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                and account_id = #{data.accountId}
                and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                #{data.accountId})
                ),0),0 ) > 0 then '借'
                when (select ifnull(sum(b.debtor_balance),0) - ifnull(sum(b.credit_balance),0)
                from wk_finance_certificate_detail as b
                left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
                where DATE_FORMAT(a.certificate_time,'%Y%m') = #{x}
                and a.account_id = #{data.accountId}
                and b.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                <if test="data.assistIds != null and data.assistIds.size > 0">
                    and b.assist_id in
                    <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                        #{assistId}
                    </foreach>
                </if>
                ) +
                if((select DATE_FORMAT(start_time,'%Y%m') from wk_finance_parameter
                where account_id = #{data.accountId}
                ) = DATE_FORMAT(#{x},'%Y%m'),ifnull((select sum(initial_balance) from wk_finance_initial
                where subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                and account_id = #{data.accountId}
                and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                #{data.accountId})
                ),0),0 ) = 0 then '平'
                else '贷'
                end as balance_direction,
                abs((select ifnull(sum(b.debtor_balance),0) - ifnull(sum(b.credit_balance),0)
                from wk_finance_certificate_detail as b
                left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
                where DATE_FORMAT(a.certificate_time,'%Y%m') = #{x}
                and a.account_id = #{data.accountId}
                and b.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                <if test="data.assistIds != null and data.assistIds.size > 0">
                    and b.assist_id in
                    <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                        #{assistId}
                    </foreach>
                </if>
                ) +
                if((select DATE_FORMAT(start_time,'%Y%m') from wk_finance_parameter
                where account_id = #{data.accountId}
                ) = DATE_FORMAT(#{x},'%Y%m'),ifnull((select sum(initial_balance) from wk_finance_initial
                where subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                and account_id = #{data.accountId}
                and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
                #{data.accountId})
                ),0),0 )) as balance
                ,
                null as balance_quantity
            </if>
            , '3' as `type`,'' as certificate_id,DATE_FORMAT(CONCAT(#{x},'01'),'%Y%m') as monthTime
            ,DATE_FORMAT(CONCAT(#{x},'01'),'%Y') as yearTime,
            (select ifnull(sum(b.quantity),0)
            from wk_finance_certificate_detail as b
            left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
            left join wk_finance_subject as z on b.subject_id = z.subject_id
            where DATE_FORMAT(a.certificate_time,'%Y%m') = #{x}
            and ifnull(b.debtor_balance,0) > 0
            and a.account_id = #{data.accountId}
            and b.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and b.assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
            </if>
            ) as debtor_quantity,
            (select ifnull(sum(b.quantity),0)
            from wk_finance_certificate_detail as b
            left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
            left join wk_finance_subject as z on b.subject_id = z.subject_id
            where DATE_FORMAT(a.certificate_time,'%Y%m') = #{x}
            and ifnull(b.credit_balance,0) > 0
            and a.account_id = #{data.accountId}
            and b.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and b.assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
            </if>
            ) as credit_quantity,
            (select ifnull(sum(b.debtor_balance),0)
            from wk_finance_certificate_detail as b
            left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
            where DATE_FORMAT(a.certificate_time,'%Y%m') = #{x}
            and a.account_id = #{data.accountId}
            and b.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and b.assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
            </if>
            ) / (select ifnull(sum(b.quantity),0)
            from wk_finance_certificate_detail as b
            left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
            left join wk_finance_subject as z on b.subject_id = z.subject_id
            where DATE_FORMAT(a.certificate_time,'%Y%m') = #{x}
            and ifnull(b.debtor_balance,0) > 0
            and a.account_id = #{data.accountId}
            and b.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) as debtor_amount_unit, (select ifnull(sum(b.credit_balance),0)
            from wk_finance_certificate_detail as b
            left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
            where DATE_FORMAT(a.certificate_time,'%Y%m') = #{x}
            and a.account_id = #{data.accountId}
            and b.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) / (select ifnull(sum(b.quantity),0)
            from wk_finance_certificate_detail as b
            left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
            left join wk_finance_subject as z on b.subject_id = z.subject_id
            where DATE_FORMAT(a.certificate_time,'%Y%m') = #{x}
            and ifnull(b.credit_balance,0) > 0
            and a.account_id = #{data.accountId}
            and b.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) as credit_amount_unit,
            null as balance_amount_unit
            union all
            select last_day(DATE_FORMAT(CONCAT(#{x},'01'),'%Y-%m-%d')) as account_time,
            null as certificate_num , '本年累计' as digest_content ,
            (select ifnull(sum(b.debtor_balance),0)
            from wk_finance_certificate_detail as b
            left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
            where DATE_FORMAT(a.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01'),'%Y')
            and DATE_FORMAT(a.certificate_time,'%Y%m') &lt;= #{x}
            and a.account_id = #{data.accountId}
            and b.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and b.assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
            </if>
            ) + if((select DATE_FORMAT(start_time,'%Y') from wk_finance_parameter
            where account_id = #{data.accountId}
            ) = DATE_FORMAT(CONCAT(#{x},'01'),'%Y'),ifnull((select sum(add_up_debtor_balance) from wk_finance_initial
            where subject_id = #{data.subjectId}
            and account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0),0 ) as debtor_balance,
            (select ifnull(sum(b.credit_balance),0)
            from wk_finance_certificate_detail as b
            left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
            where DATE_FORMAT(a.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01'),'%Y')
            and DATE_FORMAT(a.certificate_time,'%Y%m') &lt;= #{x}
            and a.account_id = #{data.accountId}
            and b.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and b.assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
            </if>
            ) + if((select DATE_FORMAT(start_time,'%Y') from wk_finance_parameter
            where account_id = #{data.accountId}
            ) = DATE_FORMAT(CONCAT(#{x},'01'),'%Y'),ifnull((select sum(add_up_credit_balance) from wk_finance_initial
            where subject_id = #{data.subjectId}
            and account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0),0 ) as credit_balance,
            <if test="data.accountBookDirection == 1">
                if( (select ifnull(sum(b.debtor_balance),0) - ifnull(sum(b.credit_balance),0)
                from wk_finance_certificate_detail as b
                left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
                where DATE_FORMAT(a.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01'),'%Y')
                and DATE_FORMAT(a.certificate_time,'%Y%m') &lt;= #{x}
                and a.account_id = #{data.accountId}
                and b.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                <if test="data.assistIds != null and data.assistIds.size > 0">
                    and b.assist_id in
                    <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                        #{assistId}
                    </foreach>
                </if>
                ) = 0,'平','借' ) as balance_direction,
                (select ifnull(sum(b.debtor_balance),0) - ifnull(sum(b.credit_balance),0)
                from wk_finance_certificate_detail as b
                left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
                where DATE_FORMAT(a.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01'),'%Y')
                and DATE_FORMAT(a.certificate_time,'%Y%m') &lt;= #{x}
                and a.account_id = #{data.accountId}
                and b.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                <if test="data.assistIds != null and data.assistIds.size > 0">
                    and b.assist_id in
                    <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                        #{assistId}
                    </foreach>
                </if>
                ) as balance
                ,
                null as balance_quantity
            </if>
            <if test="data.accountBookDirection == 2">
                case
                when (select ifnull(sum(b.debtor_balance),0) - ifnull(sum(b.credit_balance),0)
                from wk_finance_certificate_detail as b
                left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
                where DATE_FORMAT(a.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01'),'%Y')
                and DATE_FORMAT(a.certificate_time,'%Y%m') &lt;= #{x}
                and a.account_id = #{data.accountId}
                and b.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                <if test="data.assistIds != null and data.assistIds.size > 0">
                    and b.assist_id in
                    <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                        #{assistId}
                    </foreach>
                </if>
                ) > 0 then '借'
                when (select ifnull(sum(b.debtor_balance),0) - ifnull(sum(b.credit_balance),0)
                from wk_finance_certificate_detail as b
                left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
                where DATE_FORMAT(a.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01'),'%Y')
                and DATE_FORMAT(a.certificate_time,'%Y%m') &lt;= #{x}
                and a.account_id = #{data.accountId}
                and b.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                <if test="data.assistIds != null and data.assistIds.size > 0">
                    and b.assist_id in
                    <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                        #{assistId}
                    </foreach>
                </if>
                ) = 0 then '平'
                else '贷'
                end as balance_direction,
                abs((select ifnull(sum(b.debtor_balance),0) - ifnull(sum(b.credit_balance),0)
                from wk_finance_certificate_detail as b
                left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
                where DATE_FORMAT(a.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01'),'%Y')
                and DATE_FORMAT(a.certificate_time,'%Y%m') &lt;= #{x}
                and a.account_id = #{data.accountId}
                and b.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
                <if test="data.assistIds != null and data.assistIds.size > 0">
                    and b.assist_id in
                    <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                        #{assistId}
                    </foreach>
                </if>
                )) as balance
                ,
                null as balance_quantity
            </if>
            , '4' as `type`,null as certificate_id,DATE_FORMAT(CONCAT(#{x},'01'),'%Y%m') as monthTime
            ,DATE_FORMAT(CONCAT(#{x},'01'),'%Y') as yearTime,
            (select ifnull(sum(b.quantity),0)
            from wk_finance_certificate_detail as b
            left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
            left join wk_finance_subject as z on b.subject_id = z.subject_id
            where DATE_FORMAT(a.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01'),'%Y')
            and DATE_FORMAT(a.certificate_time,'%Y%m') &lt;= #{x}
            and ifnull(b.debtor_balance,0) > 0
            and a.account_id = #{data.accountId}
            and b.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and b.assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
            </if>
            ) + if((select DATE_FORMAT(start_time,'%Y') from wk_finance_parameter
            where account_id = #{data.accountId}
            ) = DATE_FORMAT(CONCAT(#{x},'01'),'%Y'),ifnull((select sum(add_up_debtor_num) from wk_finance_initial
            where subject_id = #{data.subjectId}
            and account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0),0 ) as debtor_quantity,
            (select ifnull(sum(b.quantity),0)
            from wk_finance_certificate_detail as b
            left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
            left join wk_finance_subject as z on b.subject_id = z.subject_id
            where DATE_FORMAT(a.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01'),'%Y')
            and DATE_FORMAT(a.certificate_time,'%Y%m') &lt;= #{x}
            and ifnull(b.credit_balance,0) > 0
            and a.account_id = #{data.accountId}
            and b.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            <if test="data.assistIds != null and data.assistIds.size > 0">
                and b.assist_id in
                <foreach collection="data.assistIds" index="index" open="(" close=")" separator="," item="assistId">
                    #{assistId}
                </foreach>
            </if>
            ) + if((select DATE_FORMAT(start_time,'%Y') from wk_finance_parameter
            where account_id = #{data.accountId}
            ) = DATE_FORMAT(CONCAT(#{x},'01'),'%Y'),ifnull((select sum(add_up_credit_num) from wk_finance_initial
            where subject_id = #{data.subjectId}
            and account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0),0 ) as credit_quantity,
            ((select ifnull(sum(b.debtor_balance),0)
            from wk_finance_certificate_detail as b
            left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
            where DATE_FORMAT(a.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01'),'%Y')
            and DATE_FORMAT(a.certificate_time,'%Y%m') &lt;= #{x}
            and a.account_id = #{data.accountId}
            and b.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) + if((select DATE_FORMAT(start_time,'%Y') from wk_finance_parameter
            where account_id = #{data.accountId}
            ) = DATE_FORMAT(CONCAT(#{x},'01'),'%Y'),ifnull((select sum(add_up_debtor_balance) from wk_finance_initial
            where subject_id = #{data.subjectId}
            and account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0),0 ) )/ ((select ifnull(sum(b.quantity),0)
            from wk_finance_certificate_detail as b
            left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
            left join wk_finance_subject as z on b.subject_id = z.subject_id
            where DATE_FORMAT(a.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01'),'%Y')
            and DATE_FORMAT(a.certificate_time,'%Y%m') &lt;= #{x}
            and ifnull(b.debtor_balance,0) > 0
            and a.account_id = #{data.accountId}
            and b.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) + if((select DATE_FORMAT(start_time,'%Y') from wk_finance_parameter
            where account_id = #{data.accountId}
            ) = DATE_FORMAT(CONCAT(#{x},'01'),'%Y'),ifnull((select sum(add_up_debtor_num) from wk_finance_initial
            where subject_id = #{data.subjectId}
            and account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0),0 ) )as debtor_amount_unit,
            ( (select ifnull(sum(b.credit_balance),0)
            from wk_finance_certificate_detail as b
            left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
            where DATE_FORMAT(a.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01'),'%Y')
            and DATE_FORMAT(a.certificate_time,'%Y%m') &lt;= #{x}
            and a.account_id = #{data.accountId}
            and b.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) + if((select DATE_FORMAT(start_time,'%Y') from wk_finance_parameter
            where account_id = #{data.accountId}
            ) = DATE_FORMAT(CONCAT(#{x},'01'),'%Y'),ifnull((select sum(add_up_credit_balance) from wk_finance_initial
            where subject_id = #{data.subjectId}
            and account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0),0 ))/ ((select ifnull(sum(b.quantity),0)
            from wk_finance_certificate_detail as b
            left join wk_finance_certificate as a on b.certificate_id = a.certificate_id
            left join wk_finance_subject as z on b.subject_id = z.subject_id
            where DATE_FORMAT(a.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01'),'%Y')
            and DATE_FORMAT(a.certificate_time,'%Y%m') &lt;= #{x}
            and ifnull(b.credit_balance,0) > 0
            and a.account_id = #{data.accountId}
            and b.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) + if((select DATE_FORMAT(start_time,'%Y') from wk_finance_parameter
            where account_id = #{data.accountId}
            ) = DATE_FORMAT(CONCAT(#{x},'01'),'%Y'),ifnull((select sum(add_up_credit_num) from wk_finance_initial
            where subject_id = #{data.subjectId}
            and account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0),0 ) ) as credit_amount_unit,
            null as balance_amount_unit
        </foreach>
    </select>
    <select id="queryAmountDetailUpAccount" resultType="com.alibaba.fastjson.JSONObject">
        select lwve.*,abs(lwve.initial_balance / lwve.initial_quantity) as initial_unit_price,
        FORMAT(abs( lwve.end_balance / lwve.end_quantity ),2) as initial_end_price
        from ( select a.subject_id,a.number,a.subject_name,a.amount_unit,
        <if test="data.accountBookDirection == 1">
            if((select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(a.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial
            where subject_id = a.subject_id
            and account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0) = 0,'平',if(a.balance_direction = 1,'借','贷') )
            as initial_balance_direction,
            if(a.balance_direction = 1,
            (select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(a.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial
            where subject_id = a.subject_id
            and account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0),(select ifnull(sum(e.credit_balance),0) - ifnull(sum(e.debtor_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(a.balance_direction = 2,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial
            where subject_id = a.subject_id
            and account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0)) as initial_balance,
            if(a.balance_direction = 1,
            (select if(e.debtor_balance is not null and e.debtor_balance != 0,ifnull(sum(e.quantity),0),0)
            - if(e.credit_balance is not null and e.credit_balance != 0,ifnull(sum(e.quantity),0),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            left join wk_finance_subject as w on w.subject_id = e.subject_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(a.balance_direction = 1,sum(initial_num),0 - sum(initial_num))
            from wk_finance_initial
            where subject_id = a.subject_id
            and account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0),(select if(e.debtor_balance is not null and e.debtor_balance != 0,ifnull(sum(e.quantity),0),0)
            - if(e.credit_balance is not null and e.credit_balance != 0,ifnull(sum(e.quantity),0),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            left join wk_finance_subject as w on w.subject_id = e.subject_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(a.balance_direction = 2,sum(initial_num),0 - sum(initial_num))
            from wk_finance_initial
            where subject_id = a.subject_id
            and account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0)) as initial_quantity,
            if((select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= DATE_FORMAT(#{data.endTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(a.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial
            where subject_id = a.subject_id
            and account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0) = 0,'平',if(a.balance_direction = 1,'借','贷') )
            as end_balance_direction,
            if(a.balance_direction = 1,
            (select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= DATE_FORMAT(#{data.endTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(a.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial
            where subject_id = a.subject_id
            and account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0),(select ifnull(sum(e.credit_balance),0) - ifnull(sum(e.debtor_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= DATE_FORMAT(#{data.endTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(a.balance_direction = 2,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial
            where subject_id = a.subject_id
            and account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0)) as end_balance,
            if(a.balance_direction = 1,
            (select if(e.debtor_balance is not null and e.debtor_balance != 0,ifnull(sum(e.quantity),0),0)
            - if(e.credit_balance is not null and e.credit_balance != 0,ifnull(sum(e.quantity),0),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            left join wk_finance_subject as w on w.subject_id = e.subject_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= DATE_FORMAT(#{data.endTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(a.balance_direction = 1,sum(initial_num),0 - sum(initial_num))
            from wk_finance_initial
            where subject_id = a.subject_id
            and account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0),(select if(e.credit_balance is not null and e.credit_balance != 0,ifnull(sum(e.quantity),0),0)
            - if(e.debtor_balance is not null and e.debtor_balance != 0,ifnull(sum(e.quantity),0),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            left join wk_finance_subject as w on w.subject_id = e.subject_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= DATE_FORMAT(#{data.endTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(a.balance_direction = 2,sum(initial_num),0 - sum(initial_num))
            from wk_finance_initial
            where subject_id = a.subject_id
            and account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0)) as end_quantity,
        </if>
        <if test="data.accountBookDirection == 2">
            if((select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(a.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial
            where subject_id = a.subject_id
            and account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0) = 0,'平',if((select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(a.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial as w
            where w.subject_id = a.subject_id
            and w.account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0) > 0,'借','贷') ) as initial_balance_direction,
            abs(((select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(a.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial as w
            where w.subject_id = a.subject_id
            and w.account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0))) as initial_balance,
            abs(if(a.balance_direction = 1,
            (select if(e.debtor_balance is not null and e.debtor_balance != 0,ifnull(sum(e.quantity),0),0)
            - if(e.credit_balance is not null and e.credit_balance != 0,ifnull(sum(e.quantity),0),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            left join wk_finance_subject as w on w.subject_id = e.subject_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(a.balance_direction = 1,sum(initial_num),0 - sum(initial_num))
            from wk_finance_initial as w
            where w.subject_id = a.subject_id
            and w.account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0),(select if(e.credit_balance is not null and e.credit_balance != 0,ifnull(sum(e.quantity),0),0)
            - if(e.debtor_balance is not null and e.debtor_balance != 0,ifnull(sum(e.quantity),0),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            left join wk_finance_subject as w on w.subject_id = e.subject_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(a.balance_direction = 2,sum(initial_num),0 - sum(initial_num))
            from wk_finance_initial as w
            where w.subject_id = a.subject_id
            and w.account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0))) as initial_quantity,
            if((select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(a.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial as w
            where w.subject_id = a.subject_id
            and w.account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0) = 0,'平',if((select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(a.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial as w
            where w.subject_id = a.subject_id
            and w.account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0) > 0,'借','贷') ) as end_balance_direction,
            abs((select ifnull(sum(e.debtor_balance),0) - ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(a.balance_direction = 1,sum(initial_balance),0 - sum(initial_balance))
            from wk_finance_initial as w
            where w.subject_id = a.subject_id
            and w.account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0)) as end_balance,
            abs(if(a.balance_direction = 1,
            (select if(e.debtor_balance is not null and e.debtor_balance != 0,ifnull(sum(e.quantity),0),0)
            - if(e.credit_balance is not null and e.credit_balance != 0,ifnull(sum(e.quantity),0),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            left join wk_finance_subject as w on w.subject_id = e.subject_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(a.balance_direction = 1,sum(initial_num),0 - sum(initial_num))
            from wk_finance_initial as w
            where w.subject_id = a.subject_id
            and w.account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0),(select if(e.credit_balance is not null and e.credit_balance != 0,ifnull(sum(e.quantity),0),0)
            - if(e.debtor_balance is not null and e.debtor_balance != 0,ifnull(sum(e.quantity),0),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            left join wk_finance_subject as w on w.subject_id = e.subject_id
            where DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= DATE_FORMAT(#{data.startTime},'%Y%m')
            and c.account_id = #{data.accountId}
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
            ) +
            ifnull((select if(a.balance_direction = 2,sum(initial_num),0 - sum(initial_num))
            from wk_finance_initial as w
            where w.subject_id = a.subject_id
            and w.account_id = #{data.accountId}
            and initial_id not in (select initial_id from wk_finance_initial_assist where account_id =
            #{data.accountId})
            ),0))) as end_quantity,
        </if>
        (select ifnull(sum(e.debtor_balance),0)
        from wk_finance_certificate_detail as e
        left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
        where DATE_FORMAT(c.certificate_time,'%Y%m') >= DATE_FORMAT(#{data.startTime},'%Y%m')
        and DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= DATE_FORMAT(#{data.endTime},'%Y%m')
        and c.account_id = #{data.accountId}
        and e.subject_id in
        <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
            #{subjectId}
        </foreach>
        ) as debtor_balance,
        (select ifnull(sum(e.credit_balance),0)
        from wk_finance_certificate_detail as e
        left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
        where DATE_FORMAT(c.certificate_time,'%Y%m') >= DATE_FORMAT(#{data.startTime},'%Y%m')
        and DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= DATE_FORMAT(#{data.endTime},'%Y%m')
        and c.account_id = #{data.accountId}
        and e.subject_id in
        <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
            #{subjectId}
        </foreach>
        ) as credit_balance,
        (select
        if(e.debtor_balance is not null and e.debtor_balance > 0 ,ifnull(sum(e.quantity),0),0)
        from wk_finance_certificate_detail as e
        left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
        left join wk_finance_subject as w on w.subject_id = e.subject_id
        where DATE_FORMAT(c.certificate_time,'%Y%m') >= DATE_FORMAT(#{data.startTime},'%Y%m')
        and DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= DATE_FORMAT(#{data.endTime},'%Y%m')
        and c.account_id = #{data.accountId}
        and e.subject_id in
        <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
            #{subjectId}
        </foreach>
        ) as debtor_quantity,
        (select
        if(e.credit_balance is not null and e.credit_balance > 0,ifnull(sum(e.quantity),0),0)
        from wk_finance_certificate_detail as e
        left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
        left join wk_finance_subject as w on w.subject_id = e.subject_id
        where DATE_FORMAT(c.certificate_time,'%Y%m') >= DATE_FORMAT(#{data.startTime},'%Y%m')
        and DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= DATE_FORMAT(#{data.endTime},'%Y%m')
        and c.account_id = #{data.accountId}
        and e.subject_id in
        <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
            #{subjectId}
        </foreach>
        ) as credit_quantity,
        (select ifnull(sum(e.debtor_balance),0)
        from wk_finance_certificate_detail as e
        left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
        where DATE_FORMAT(c.certificate_time,'%Y%m') >= DATE_FORMAT(#{data.startTime},'%Y%m')
        and DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= DATE_FORMAT(#{data.endTime},'%Y%m')
        and DATE_FORMAT(c.certificate_time,'%Y') = DATE_FORMAT(#{data.endTime},'%Y')
        and c.account_id = #{data.accountId}
        and e.subject_id in
        <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
            #{subjectId}
        </foreach>
        ) + if((select DATE_FORMAT(start_time,'%Y') from wk_finance_parameter
        where account_id = #{data.accountId}
        ) = DATE_FORMAT(#{data.endTime},'%Y'),ifnull((select sum(add_up_debtor_balance) from wk_finance_initial
        where subject_id = #{data.subjectId}
        and account_id = #{data.accountId}
        and initial_id not in (select initial_id from wk_finance_initial_assist where account_id = #{data.accountId})
        ),0),0 )
        as debtor_year_balance,
        (select ifnull(sum(e.credit_balance),0)
        from wk_finance_certificate_detail as e
        left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
        where DATE_FORMAT(c.certificate_time,'%Y%m') >= DATE_FORMAT(#{data.startTime},'%Y%m')
        and DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= DATE_FORMAT(#{data.endTime},'%Y%m')
        and DATE_FORMAT(c.certificate_time,'%Y') = DATE_FORMAT(#{data.endTime},'%Y')
        and c.account_id = #{data.accountId}
        and e.subject_id in
        <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
            #{subjectId}
        </foreach>
        ) + if((select DATE_FORMAT(start_time,'%Y') from wk_finance_parameter
        where account_id = #{data.accountId}
        ) = DATE_FORMAT(#{data.endTime},'%Y'),ifnull((select sum(add_up_credit_balance) from wk_finance_initial
        where subject_id = #{data.subjectId}
        and account_id = #{data.accountId}
        and initial_id not in (select initial_id from wk_finance_initial_assist where account_id = #{data.accountId})
        ),0),0 ) as credit_year_balance,
        (select
        if(e.debtor_balance is not null and e.debtor_balance != 0,ifnull(sum(e.quantity),0),0)
        from wk_finance_certificate_detail as e
        left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
        left join wk_finance_subject as w on w.subject_id = e.subject_id
        where DATE_FORMAT(c.certificate_time,'%Y%m') >= DATE_FORMAT(#{data.startTime},'%Y%m')
        and DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= DATE_FORMAT(#{data.endTime},'%Y%m')
        and DATE_FORMAT(c.certificate_time,'%Y') = DATE_FORMAT(#{data.endTime},'%Y')
        and c.account_id = #{data.accountId}
        and e.subject_id in
        <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
            #{subjectId}
        </foreach>
        ) + if((select DATE_FORMAT(start_time,'%Y') from wk_finance_parameter
        where account_id = #{data.accountId}
        ) = DATE_FORMAT(#{data.endTime},'%Y'),ifnull((select sum(add_up_debtor_num) from wk_finance_initial
        where subject_id = #{data.subjectId}
        and account_id = #{data.accountId}
        and initial_id not in (select initial_id from wk_finance_initial_assist where account_id = #{data.accountId})
        ),0),0 ) as debtor_year_quantity,
        (select
        if(e.credit_balance is not null and e.credit_balance != 0 ,ifnull(sum(e.quantity),0),0)
        from wk_finance_certificate_detail as e
        left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
        left join wk_finance_subject as w on w.subject_id = e.subject_id
        where DATE_FORMAT(c.certificate_time,'%Y%m') >= DATE_FORMAT(#{data.startTime},'%Y%m')
        and DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= DATE_FORMAT(#{data.endTime},'%Y%m')
        and DATE_FORMAT(c.certificate_time,'%Y') = DATE_FORMAT(#{data.endTime},'%Y')
        and c.account_id = #{data.accountId}
        and e.subject_id in
        <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
            #{subjectId}
        </foreach>
        ) + if((select DATE_FORMAT(start_time,'%Y') from wk_finance_parameter
        where account_id = #{data.accountId}
        ) = DATE_FORMAT(#{data.endTime},'%Y'),ifnull((select sum(add_up_credit_num) from wk_finance_initial
        where subject_id = #{data.subjectId}
        and account_id = #{data.accountId}
        and initial_id not in (select initial_id from wk_finance_initial_assist where account_id = #{data.accountId})
        ),0),0 ) as credit_year_quantity
        from wk_finance_subject as a
        where subject_id = #{data.subjectId}
        ) as lwve
    </select>

    <select id="queryItemsDetailAccount" resultType="com.alibaba.fastjson.JSONObject">
        select
        last_day(DATE(#{data.startTime})) as account_time,
        null as certificate_num ,
        '期初余额' as digest_content ,
        ifnull( sum( e.credit_balance ), 0 ) AS credit_balance,
        ifnull( sum( e.debtor_balance ), 0 ) AS debtor_balance,
        '1' as `type`,
        DATE_FORMAT(#{data.startTime},'%Y%m') as monthTime,
        YEAR(#{data.startTime}) as yearTime,
        null as balanceDirection,
        null as certificate_id
        from wk_finance_certificate_detail as e
        left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
        left join wk_finance_assist_adjuvant as f on f.assist_id = e.assist_id
        where DATE_FORMAT(c.certificate_time,'%Y%m') &lt; DATE_FORMAT(#{data.startTime},'%Y%m')
        and e.account_id = #{data.accountId}
        <if test="data.subjectIds != null and data.subjectIds.size > 0">
            and e.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
        </if>
        <if test="data.relationId != null and data.relationId != ''">
            AND f.relation_id = #{data.relationId}
        </if>
        union all
        <foreach collection="data.timeList" item="x" separator="union all">
            select *
            from(
            select DATE_FORMAT(a.certificate_time,'%Y-%m-%d') as account_time,
            CONCAT(c.voucher_name,'_',a.certificate_num) as certificate_num ,
            b.digest_content,
            ifnull(b.credit_balance,0) as credit_balance,
            ifnull(b.debtor_balance,0) as debtor_balance,
            '2' as `type`,
            DATE_FORMAT(a.certificate_time,'%Y%m') as monthTime,
            YEAR(a.certificate_time) as yearTime,
            if(d.balance_direction = 1,'借','贷') as balanceDirection,
            b.certificate_id
            from wk_finance_certificate_detail as b
            left join wk_finance_certificate as a on a.certificate_id = b.certificate_id
            left join wk_finance_voucher as c on a.voucher_id = c.voucher_id
            left join wk_finance_subject as d on b.subject_id = d.subject_id
            where DATE_FORMAT(a.certificate_time,'%Y%m') = #{x}
            and a.account_id = #{data.accountId}
            <if test="data.subjectIds != null and data.subjectIds.size > 0">
                and b.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
            </if>
            <if test="data.relationId != null and data.relationId != ''">
                and b.assist_id in (SELECT assist_id FROM wk_finance_assist_adjuvant WHERE relation_id =
                #{data.relationId})
                and b.assist_id is not null
            </if>
            order by a.certificate_num asc
            ) as lict
            union all
            select last_day(DATE(CONCAT(#{x},'01'))) as account_time,
            null as certificate_num ,
            '本期合计' as digest_content ,
            ifnull( sum( e.credit_balance ), 0 ) AS credit_balance,
            ifnull( sum( e.debtor_balance ), 0 ) AS debtor_balance,
            '3' as `type`,
            DATE_FORMAT(CONCAT(#{x},'01'),'%Y%m') as monthTime,
            YEAR(CONCAT(#{x},'01')) as yearTime,
            null as balanceDirection,
            null as certificate_id
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            <if test="data.relationId != null and data.relationId != ''">
                left join wk_finance_assist_adjuvant as f on f.assist_id = e.assist_id
            </if>
            where DATE_FORMAT(c.certificate_time,'%Y%m') = #{x}
            and e.account_id = #{data.accountId}
            <if test="data.subjectIds != null and data.subjectIds.size > 0">
                and e.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
            </if>
            <if test="data.relationId != null and data.relationId != ''">
                AND f.relation_id = #{data.relationId}
            </if>
            union all
            select last_day(DATE_FORMAT(CONCAT(#{x},'01'),'%Y-%m-%d')) as account_time,
            null as certificate_num ,
            '本年累计' as digest_content ,
            (select ifnull(sum(e.credit_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            left join wk_finance_assist_adjuvant as f on f.assist_id = e.assist_id
            where DATE_FORMAT(c.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01'),'%Y')
            and DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= #{x}
            and e.account_id = #{data.accountId}
            <if test="data.subjectIds != null and data.subjectIds.size > 0">
                and e.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
            </if>
            <if test="data.relationId != null and data.relationId != ''">
                AND f.relation_id = #{data.relationId}
            </if>
            ) + if((select DATE_FORMAT(start_time,'%Y') from wk_finance_parameter
            where account_id = #{data.accountId}
            ) = DATE_FORMAT(CONCAT(#{x},'01'),'%Y'),ifnull((select sum(add_up_credit_balance) from wk_finance_initial as
            a
            left join wk_finance_initial_assist as b on a.initial_id = b.initial_id
            left join wk_finance_assist_adjuvant as c on b.finance_assist_id = c.assist_id
            where a.account_id = #{data.accountId}
            <if test="data.subjectIds != null and data.subjectIds.size > 0">
                and a.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
            </if>
            <if test="data.relationId != null and data.relationId != ''">
                AND c.relation_id = #{data.relationId}
            </if>
            ),0),0 ) as credit_balance,
            (select ifnull(sum(e.debtor_balance),0)
            from wk_finance_certificate_detail as e
            left join wk_finance_certificate as c on e.certificate_id = c.certificate_id
            left join wk_finance_assist_adjuvant as f on f.assist_id = e.assist_id
            where DATE_FORMAT(c.certificate_time,'%Y') = DATE_FORMAT(CONCAT(#{x},'01'),'%Y')
            and DATE_FORMAT(c.certificate_time,'%Y%m') &lt;= #{x}
            and e.account_id = #{data.accountId}
            <if test="data.subjectIds != null and data.subjectIds.size > 0">
                and e.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
            </if>
            <if test="data.relationId != null and data.relationId != ''">
                AND f.relation_id = #{data.relationId}
            </if>
            ) + if((select DATE_FORMAT(start_time,'%Y') from wk_finance_parameter
            where account_id = #{data.accountId}
            ) = DATE_FORMAT(CONCAT(#{x},'01'),'%Y'),ifnull((select sum(add_up_debtor_balance) from wk_finance_initial as
            a
            left join wk_finance_initial_assist as b on a.initial_id = b.initial_id
            left join wk_finance_assist_adjuvant as c on b.finance_assist_id = c.assist_id
            where a.account_id = #{data.accountId}
            <if test="data.subjectIds != null and data.subjectIds.size > 0">
                and a.subject_id in
                <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                    #{subjectId}
                </foreach>
            </if>
            <if test="data.relationId != null and data.relationId != ''">
                AND c.relation_id = #{data.relationId}
            </if>
            ),0),0 )
            as debtor_balance,
            '4' as `type`
            ,DATE_FORMAT(CONCAT(#{x},'01'),'%Y%m') as monthTime
            ,DATE_FORMAT(CONCAT(#{x},'01'),'%Y') as yearTime,
             null as balanceDirection,
             null as certificate_id
        </foreach>
    </select>

    <select id="countDetailAccount" resultType="java.math.BigDecimal">
        SELECT
        IFNULL(sum(e.debtor_balance)-sum(e.credit_balance),0) as balance
        FROM
        wk_finance_certificate_detail AS e
        LEFT JOIN wk_finance_certificate AS c ON e.certificate_id = c.certificate_id
        LEFT JOIN wk_finance_certificate_association AS d ON e.detail_id = d.detail_id
        WHERE
        DATE_FORMAT( c.certificate_time, '%Y%m') &lt; DATE_FORMAT(#{data.startTime}, '%Y%m' )
        AND c.account_id = #{data.accountId}
        AND d.adjuvant_id= #{data.adjuvantId}
        AND d.relation_id = #{data.relationId}
        <if test="data.subjectId != null and data.subjectId != ''">
            AND e.subject_id = #{data.subjectId}
        </if>
    </select>
    <select id="queryCertificateDetailById"
            resultType="com.kakarote.finance.entity.PO.FinanceCertificateDetail">
        select a.*, b.subject_name
        from wk_finance_certificate_detail as a
        left join wk_finance_subject as b on a.subject_id = b.subject_id
        where a.certificate_id = #{data.certificateId}
        order by a.sort
    </select>

    <select id="queryFinalDetailBalanceAccount" resultType="com.alibaba.fastjson.JSONObject">
        select f.* from (
        select a.subject_id,a.balance_direction,a.subject_name,a.number,a.grade,
        ifnull( sum(if(DATE_FORMAT(c.certificate_time, '%Y%m') &lt;= #{data.endTime} and DATE_FORMAT(c.certificate_time,
        '%Y%m') >= #{data.startTime},b.debtor_balance,0)) ,0)as debtor_current_balance,
        ifnull( sum(if(DATE_FORMAT(c.certificate_time, '%Y%m') &lt;= #{data.endTime} and DATE_FORMAT(c.certificate_time,
        '%Y%m') >= #{data.startTime},b.credit_balance,0)),0) as credit_current_balance,
        ifnull( sum(if(DATE_FORMAT(c.certificate_time, '%Y%m') &lt;= #{data.endTime} and
        DATE_FORMAT(c.certificate_time, '%Y') = DATE_FORMAT(CONCAT(#{data.endTime}, '01'), '%Y'),b.debtor_balance,0)),0)
        as debtor_year_balance,
        ifnull( sum(if(DATE_FORMAT(c.certificate_time, '%Y%m') &lt;= #{data.endTime} and
        DATE_FORMAT(c.certificate_time, '%Y') = DATE_FORMAT(CONCAT(#{data.endTime}, '01'), '%Y'),b.credit_balance,0)),0)
        as credit_year_balance,
        ifnull( sum(if( DATE_FORMAT(c.certificate_time,'%Y') &lt;
        DATE_FORMAT(CONCAT(#{data.startTime},'01'),'%Y'),b.debtor_balance,0)),0) as debtor_last_year_current_balance,
        ifnull( sum(if( DATE_FORMAT(c.certificate_time,'%Y') &lt;
        DATE_FORMAT(CONCAT(#{data.startTime},'01'),'%Y'),b.credit_balance,0)),0) as credit_last_year_current_balance,
        ifnull( sum(if(DATE_FORMAT(c.certificate_time,'%Y%m') &lt; #{data.startTime},b.debtor_balance,0)) ,0)as
        debtor_last_current_balance,
        ifnull( sum(if(DATE_FORMAT(c.certificate_time,'%Y%m') &lt; #{data.startTime},b.credit_balance,0)),0) as
        credit_last_current_balance,
        null assist_id,
        false is_assist
        from wk_finance_subject as a
        left join wk_finance_certificate_detail as b on b.subject_id = a.subject_id
        left join wk_finance_certificate as c on c.certificate_id = b.certificate_id
        where a.account_id = #{data.accountId} and a.status != 3
        and a.grade >= #{data.minLevel}
        and a.grade &lt;= #{data.maxLevel}
        <if test="data.subjectIds != null and data.subjectIds.size > 0">
            and a.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
        </if>
        <if test="data.startSubjectId != null and data.startSubjectId != ''">
            and left(a.`number`,4) >= (select left(`number`,4) from wk_finance_subject where subject_id =
            #{data.startSubjectId})
        </if>
        <if test="data.endSubjectId != null and data.endSubjectId != ''">
            and left(a.`number`,4) &lt;= (select left(`number`,4) from wk_finance_subject where subject_id =
            #{data.endSubjectId})
        </if>
        GROUP BY a.subject_id
        ) as f
        UNION ALL
        select f.* from (
        select a.subject_id,
        a.balance_direction,
        (select REPLACE(concat(a.subject_name, '_', group_concat(m.carte_name)), ',', '_') as carte_name
        from wk_finance_assist_adjuvant as w
        left join wk_finance_adjuvant_carte as m on w.relation_id = m.carte_id
        where w.assist_id = b.assist_id) as subject_name,
        (select REPLACE(concat(a.number, '_', group_concat(m.carte_number)), ',', '_') as carte_number
        from wk_finance_assist_adjuvant as w
        left join wk_finance_adjuvant_carte as m on w.relation_id = m.carte_id
        where w.assist_id = b.assist_id) as number,
        null as grade,
        ifnull(sum(if(DATE_FORMAT(d.certificate_time, '%Y%m') &lt;= #{data.endTime} and DATE_FORMAT(d.certificate_time,
        '%Y%m') >= #{data.startTime},c.debtor_balance,0)),0) as debtor_current_balance,
        ifnull(sum(if(DATE_FORMAT(d.certificate_time, '%Y%m') &lt;= #{data.endTime} and DATE_FORMAT(d.certificate_time,
        '%Y%m') >= #{data.startTime},c.credit_balance,0)),0) as credit_current_balance,
        ifnull( sum(if(DATE_FORMAT(d.certificate_time, '%Y%m') &lt;= #{data.endTime} and
        DATE_FORMAT(d.certificate_time, '%Y') = DATE_FORMAT(CONCAT(#{data.endTime}, '01'), '%Y'),c.debtor_balance,0))
        ,0)as debtor_year_balance,
        ifnull( sum(if(DATE_FORMAT(d.certificate_time, '%Y%m') &lt;= #{data.endTime} and
        DATE_FORMAT(d.certificate_time, '%Y') = DATE_FORMAT(CONCAT(#{data.endTime}, '01'), '%Y'),c.credit_balance,0))
        ,0)as credit_year_balance,
        ifnull( sum(if( DATE_FORMAT(d.certificate_time,'%Y') &lt;
        DATE_FORMAT(CONCAT(#{data.startTime},'01'),'%Y'),c.debtor_balance,0)),0) as debtor_last_year_current_balance,
        ifnull( sum(if( DATE_FORMAT(d.certificate_time,'%Y') &lt;
        DATE_FORMAT(CONCAT(#{data.startTime},'01'),'%Y'),c.credit_balance,0)),0) as credit_last_year_current_balance,
        ifnull( sum(if(DATE_FORMAT(d.certificate_time,'%Y%m') &lt; #{data.startTime},c.debtor_balance,0)) ,0)as
        debtor_last_current_balance,
        ifnull( sum(if(DATE_FORMAT(d.certificate_time,'%Y%m') &lt; #{data.startTime},c.credit_balance,0)),0) as
        credit_last_current_balance,
        b.assist_id,
        true is_assist
        from wk_finance_subject a
        left join wk_finance_assist as b on b.subject_id = a.subject_id
        left join wk_finance_certificate_detail c on c.subject_id = a.subject_id and c.assist_id = b.assist_id
        left join wk_finance_certificate as d on d.certificate_id = c.certificate_id
        where a.account_id = #{data.accountId}
        and b.assist_id is not null
        and c.assist_id is not null
        and a.grade >= #{data.minLevel}
        and a.grade &lt;= #{data.maxLevel}
        <if test="data.subjectIds != null and data.subjectIds.size > 0">
            and a.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
        </if>
        <if test="data.startSubjectId != null and data.startSubjectId != ''">
            and left(a.`number`,4) >= (select left(`number`,4) from wk_finance_subject where subject_id =
            #{data.startSubjectId})
        </if>
        <if test="data.endSubjectId != null and data.endSubjectId != ''">
            and left(a.`number`,4) &lt;= (select left(`number`,4) from wk_finance_subject where subject_id =
            #{data.endSubjectId})
        </if>
        GROUP BY b.assist_id
        ) as f order by number
    </select>


    <select id="queryAdjuvantDetailBalanceAccount" resultType="com.alibaba.fastjson.JSONObject">
        SELECT
        f.*
        FROM
        (
        SELECT
        1 as balance_direction,
        m.carte_name AS name,
        m.carte_number,
        ifnull(sum(if(DATE_FORMAT(d.certificate_time, '%Y%m') &lt;= #{data.endTime} and DATE_FORMAT(d.certificate_time,
        '%Y%m') >= #{data.startTime},c.debtor_balance,0)),0) as debtor_current_balance,
        ifnull(sum(if(DATE_FORMAT(d.certificate_time, '%Y%m') &lt;= #{data.endTime} and DATE_FORMAT(d.certificate_time,
        '%Y%m') >= #{data.startTime},c.credit_balance,0)),0) as credit_current_balance,
        ifnull( sum(if(DATE_FORMAT(d.certificate_time, '%Y%m') &lt;= #{data.endTime} and
        DATE_FORMAT(d.certificate_time, '%Y') = DATE_FORMAT(CONCAT(#{data.endTime}, '01'), '%Y'),c.debtor_balance,0))
        ,0)as debtor_year_balance,
        ifnull( sum(if(DATE_FORMAT(d.certificate_time, '%Y%m') &lt;= #{data.endTime} and
        DATE_FORMAT(d.certificate_time, '%Y') = DATE_FORMAT(CONCAT(#{data.endTime}, '01'), '%Y'),c.credit_balance,0))
        ,0)as credit_year_balance,
        ifnull( sum(if( DATE_FORMAT(d.certificate_time,'%Y') &lt;
        DATE_FORMAT(CONCAT(#{data.startTime},'01'),'%Y'),c.debtor_balance,0)),0) as debtor_last_year_current_balance,
        ifnull( sum(if( DATE_FORMAT(d.certificate_time,'%Y') &lt;
        DATE_FORMAT(CONCAT(#{data.startTime},'01'),'%Y'),c.credit_balance,0)),0) as credit_last_year_current_balance,
        ifnull( sum(if(DATE_FORMAT(d.certificate_time,'%Y%m') &lt; #{data.startTime},c.debtor_balance,0)) ,0)as
        debtor_last_current_balance,
        ifnull( sum(if(DATE_FORMAT(d.certificate_time,'%Y%m') &lt; #{data.startTime},c.credit_balance,0)),0) as
        credit_last_current_balance,
        w.relation_id,
        true is_assist
        FROM
        wk_finance_subject a
        LEFT JOIN wk_finance_assist AS b ON b.subject_id = a.subject_id
        LEFT JOIN wk_finance_certificate_detail c ON c.subject_id = a.subject_id
        AND c.assist_id = b.assist_id
        LEFT JOIN wk_finance_certificate AS d ON d.certificate_id = c.certificate_id
        LEFT JOIN wk_finance_assist_adjuvant AS w ON w.assist_id = b.assist_id
        LEFT JOIN wk_finance_adjuvant_carte AS m ON w.relation_id = m.carte_id
        WHERE
        a.account_id = #{data.accountId}
        AND b.assist_id IS NOT NULL
        AND m.adjuvant_id= #{data.adjuvantId}
        <if test="data.relationId != null and data.relationId != ''">
            AND w.relation_id = #{data.relationId}
        </if>
        <if test="data.subjectIds != null and data.subjectIds.size > 0">
            and a.subject_id in
            <foreach collection="data.subjectIds" index="index" open="(" close=")" separator="," item="subjectId">
                #{subjectId}
            </foreach>
        </if>
        GROUP BY
        w.relation_id
        ) AS f
        ORDER BY
        carte_number
    </select>

    <select id="queryExistDataSubject" resultType="com.kakarote.finance.entity.VO.FinanceSubjectVO">
        SELECT a.subject_id,max(subject_content) as subject_name
        FROM wk_finance_certificate_detail AS a JOIN wk_finance_certificate AS b ON a.certificate_id = b.certificate_id
        WHERE DATE_FORMAT(b.certificate_time, '%Y%m') = #{time}
        AND a.account_id = #{accountId}
        GROUP BY subject_id
    </select>

    <select id="queryLabelNameByData" resultType="com.alibaba.fastjson.JSONObject">
        SELECT
        b.carte_name AS NAME,
        b.carte_id AS relationId,
        b.carte_number AS carteNumber
        FROM
        wk_finance_adjuvant_carte AS b
        WHERE carte_id IN (
        SELECT DISTINCT
        a.relation_id
        FROM
        wk_finance_certificate_association AS a
        LEFT JOIN wk_finance_certificate_detail AS c ON a.detail_id = c.detail_id
        LEFT JOIN wk_finance_certificate AS d ON c.certificate_id = d.certificate_id
        WHERE a.account_id = #{data.accountId} AND a.adjuvant_id = #{data.adjuvantId}
        and d.certificate_time between #{data.startTime} and #{data.endTime}
        ) and b.account_id = #{data.accountId}
    </select>
</mapper>
